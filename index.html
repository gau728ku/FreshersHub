<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FreshersHub - Job Portal</title>
  
  <style>
    /* Base styles */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom right, rgba(0, 114, 255, 0.6), rgba(0, 198, 255, 0.6)),
        url('https://images.unsplash.com/photo-1519389950473-47ba0277781c?fit=crop&w=1650&q=80') no-repeat center center;
      background-size: cover;
      background-attachment: fixed;
      color: white;
    }

    .container {
      max-width: 400px;
      margin: 5% auto;
      padding: 2rem;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }

    h2 { text-align: center; margin-bottom: 1.5rem; }
    input, select, button {
      width: 100%; padding: 12px; margin: 8px 0;
      border: none; border-radius: 8px; font-size: 1rem;
    }

    button { 
      background-color: #00c6ff; 
      color: white; 
      cursor: pointer; 
      transition: background 0.3s;
    }
    button:hover { background-color: #1c78e9; }
    button.danger { background-color: #dc3545; }
    button.danger:hover { background-color: #c82333; }
    button.success { background-color: #28a745; }
    button.success:hover { background-color: #218838; }

    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      backdrop-filter: blur(5px);
    }

    .table-container {
      overflow-x: auto;
      margin: 20px 0;
      background: white;
      border-radius: 10px;
      color: black;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }

    #adminMenuBtn, #fresherMenuBtn, #EmployerMenuBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 28px;
      cursor: pointer;
      z-index: 1001;
      display: none;
      color: white;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      text-align: center;
      line-height: 40px;
    }

    .sideMenu {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background: rgba(0,0,0,0.9);
      color: white;
      padding-top: 60px;
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    
    .sideMenu.open { transform: translateX(250px); }
    
    .sideMenu a {
      display: block;
      color: white;
      padding: 12px 20px;
      text-decoration: none;
      font-size: 18px;
      border-left: 4px solid transparent;
    }
    
    .sideMenu a:hover {
      background: rgba(255,255,255,0.1);
      border-left: 4px solid #00c6ff;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      display: none;
    }
    
    .overlay.show { display: block; }

    #toggle-text a {
      color: #00aeff; 
      font-weight: bold;
      text-decoration: underline;
      cursor: pointer;
    }

    .dashboard-section {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .stats-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    
    .stats-container.horizontal {
       flex-wrap: nowrap;
       overflow-x: auto;
       padding-bottom: 10px;
    }

    .stat-card {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      width: 200px;
      text-align: center;
      backdrop-filter: blur(5px);
    }
    
    .stat-card h3 {
      margin-top: 10px;
      font-size: 2rem;
      transition: transform 0.3s ease;
    }

    .stat-card:hover h3 {
      transform: scale(1.1);
      color: #00c6ff;
    }

    @media (max-width: 768px) {
      .stats-container {
        flex-direction: row;
        justify-content: flex-start;
      }
      .stat-card {
        min-width: 180px;
      }
    }

   /* Password Toggle */
.password-wrapper {
  position: relative;
}

.toggle-password-btn {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  color: #00c6ff;
  user-select: none;
}

/* Search Inputs */
.search-input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: none;
  margin-bottom: 15px;
}
  
/* Quick Actions */
.quick-actions {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.quick-actions input {
  padding: 10px;
  border-radius: 8px;
  border: none;
  flex: 1;
  min-width: 200px;
}

.quick-actions button {
  margin: 0;
  flex: 1;
  min-width: 120px;
}

/* Bulk Actions */
.bulk-actions {
  margin-top: 10px;
}

.table-checkbox {
  margin: 0;
  width: 18px;
  height: 18px;
}


/* Add to your <style> section */
.table-container table {
  table-layout: fixed;
  width: 100%;
}

.table-container th:nth-child(1),
.table-container td:nth-child(1) {
  width: 40px; /* Checkbox column */
  text-align: center;
}

.table-container th:nth-child(2),
.table-container td:nth-child(2) {
  width: 30%; /* Email column */
}

.table-container th:nth-child(3),
.table-container td:nth-child(3) {
  width: 20%; /* Role column */
}

.table-container th:nth-child(4),
.table-container td:nth-child(4) {
  width: 15%; /* Actions column */
}

/* Jobs Table Specific Styling */
#jobsTableBody td:nth-child(1) { width: 40px; text-align: center; } /* Checkbox */
#jobsTableBody td:nth-child(2) { width: 25%; } /* Title */
#jobsTableBody td:nth-child(3) { width: 20%; } /* Employer */
#jobsTableBody td:nth-child(4) { width: 15%; } /* Location */
#jobsTableBody td:nth-child(5) { width: 15%; } /* Salary */
#jobsTableBody td:nth-child(6) { width: 15%; } /* Actions */


/* Add to your existing styles */
.table-container td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 8px 12px;
}

.table-container th {
  padding: 12px;
}

.announcement-banner {
  background: rgba(255, 255, 255, 0.08);
  color: #ffffff;
  font-weight: 500;
  padding: 10px 20px;
  border-left: 5px solid #ffc107;
  font-size: 1rem;
  overflow: hidden;
  white-space: nowrap;
  backdrop-filter: blur(6px);
  box-shadow: 0 1px 5px rgba(0,0,0,0.2);
  margin-bottom: 10px;
  border-radius: 6px;
}

.scrolling-text {
  display: inline-block;
  animation: scroll-left 18s linear infinite;
}


@keyframes scroll-left {
  0% {
    transform: translateX(100%);
  }
  100% {
    transform: translateX(-100%);
  }
}

/* Add to your existing CSS */
.job-status {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: bold;
}

/* Loading state for buttons */
button[disabled] {
  opacity: 0.7;
  cursor: not-allowed;
}

/* Job status indicators */
.job-status[data-status="active"] {
  background-color: #28a74520;
  color: #28a745;
}
.job-status[data-status="closed"] {
  background-color: #dc354520;
  color: #dc3545;
}


  </style>
</head>
<body>

  <!-- Authentication Section -->
  <div class="container" id="auth-section">
    <h2 id="form-title">FreshersHub - Signup</h2>
    <input type="email" id="email" placeholder="Email" required />
    <div class="password-wrapper">
  <input type="password" id="password" placeholder="Password" required />
  <span id="togglePasswordBtn" class="toggle-password-btn">üëÅ‚Äçüó®</span>
</div>
    <select id="role">
      <option value="fresher">Fresher</option>
      <option value="Employer">Employer</option>
    </select>
    <button id="actionBtn" onclick="signup()">Signup</button>
    <p id="toggle-text">Already have an account? <a id="toggleLink">Login here</a></p>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" style="display:none;">
    <div id="adminMenuBtn" onclick="toggleAdminMenu()">‚ò∞</div>

    <div class="sideMenu" id="adminSideMenu">
      <a href="#" id="adminMenuHome">Dashboard</a>
      <a href="#" id="adminMenuUsers">Manage Users</a>
      <a href="#" id="adminMenuJobs">Manage Jobs</a>
      <a href="#" id="adminMenuSettings">Settings</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>

    <div class="overlay" id="adminOverlay" onclick="toggleAdminMenu()"></div>

  <!-- Admin Home Section -->
    
    <div class="dashboard-section" id="adminHomeSection">
  <h2>Admin Dashboard</h2>

  <!-- ‚úÖ Quick Actions Section -->
  <div class="quick-actions">
    <input type="email" id="banUserEmail" placeholder="Enter email to ban" required>
    <button onclick="banUser()" class="danger">Ban User</button>
    <button onclick="showAnnouncementModal()" class="success">Post Announcement</button>
    <div id="banUserFeedback" style="display: none; margin-top: 10px;"></div>
  </div>

  <!-- ‚úÖ Stats Section -->
  <div class="stats-container horizontal">
    <div class="stat-card">
      <p>Total Freshers</p>
      <h3 id="totalFreshers">-</h3>
    </div>
    <div class="stat-card">
      <p>Total Employers</p>
      <h3 id="totalEmployers">-</h3>
    </div>
    <div class="stat-card">
      <p>Total Jobs</p>
      <h3 id="totalJobs">-</h3>
    </div>
  </div>

  <!-- ‚úÖ Announcement Display -->
  <div class="card">
    <h3>Current Announcement</h3>
    <div id="currentAnnouncement" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; max-height: 120px; overflow-y: auto;">
      Loading announcement...
    </div>
    <div id="announcementActions" style="margin-top: 10px; display: none;">
      <button onclick="showAnnouncementModal()" class="success">‚úèÔ∏è Edit</button>
      <button onclick="deleteAnnouncement()" class="danger">üóëÔ∏è Delete</button>
    </div>
  </div>

  <!-- ‚úÖ Recent Activity Section -->
  <div class="card">
    <h3 style="text-align: center;">Recent Activity</h3>
    <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
      <div style="flex: 1; min-width: 300px;">
        <h4>Last 5 Users</h4>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Email</th><th>Role</th></tr>
            </thead>
            <tbody id="recentUsersTable"></tbody>
          </table>
        </div>
      </div>

      <div style="flex: 1; min-width: 300px;">
        <h4>Last 5 Jobs</h4>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Title</th><th>Employer</th><th>Location</th></tr>
            </thead>
            <tbody id="recentJobsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div> <!-- ‚úÖ End of adminHomeSection -->

    
    <!-- Manage Users Section -->
<div class="dashboard-section" id="adminUsersSection">
  <h2>Manage Users</h2>
  <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
  
  <!-- Search bar -->
  <input 
    type="text" 
    class="search-input" 
    data-table-target="usersTableBody" 
    placeholder="Search users by email or role..."
  >

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAllUsers" class="table-checkbox"></th>
          <th>Email</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>
    <!-- Bulk actions INSIDE table-container -->
    <div class="bulk-actions">
      <button onclick="deleteSelectedUsers()" class="danger">Delete Selected Users</button>
    </div>
  </div>

<!-- Add this right after the current users table -->
<div class="card" style="margin-top: 20px;">
  <h3>Deleted Users</h3>
  <p style="font-size: 0.9rem; color: #ccc;">Click email to delete permanently from Firebase</p>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Deleted On</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="deletedUsersTable"></tbody>
    </table>
  </div>
</div>

</div>

<!-- Manage Jobs Section -->
<div class="dashboard-section" id="adminJobsSection">
  <h2>Manage Job Listings</h2>
  <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
  
  <!-- Search bar -->
  <input 
    type="text" 
    class="search-input" 
    data-table-target="jobsTableBody" 
    placeholder="Search jobs by title, Employer..."
  >

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAllJobs" class="table-checkbox"></th>
          <th>Title</th>
          <th>Employer</th>
          <th>Location</th>
          <th>Salary</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="jobsTableBody"></tbody>
    </table>
    <!-- Bulk actions INSIDE table-container -->
    <div class="bulk-actions">
      <button onclick="deleteSelectedJobs()" class="danger">Delete Selected Jobs</button>
    </div>
  </div>
</div>

    <!-- Settings Section -->
    <div class="dashboard-section" id="adminSettingsSection">
      <h2>Admin Settings</h2>
      <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="card">
        <h3>System Configuration</h3>
        
      <!--Current Admins table-->
        <div id="adminSection">
          <h3>Current Admins</h3>
          <table id="adminTable">
            <thead>
              <tr><th>Email</th><th>Action</th></tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
          </table>
        
          <!--promote user to admin form-->
          <div id="addAdminSection" style="display: none;">
            <h3>Promote User to Admin</h3>
            <input type="email" id="promoteEmail" placeholder="Enter user email">
            <button onclick="promoteToAdmin()">Promote</button>
          </div>

        <!--Banned users table-->
       <div class="card">
         <h3>Banned Users</h3>
         <div class="table-container">
        <table>
         <thead>
         <tr>
          <th>Email</th>
          <th>Banned On</th>
          <th>Actions</th>
           </tr>
         </thead>
         <tbody id="bannedUsersTable"></tbody>
         </table>
        </div>
        </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Employer Dashboard -->

  <div id="EmployerDashboard" style="display:none;">

<div id="announcementBannerEmployer" class="announcement-banner" style="display: none; cursor: pointer;" onclick="showFullAnnouncement()">
  <div class="scrolling-text" id="announcementTextEmployer"></div>
</div>

    <div id="EmployerMenuBtn" onclick="toggleEmployerMenu()">‚ò∞</div>
    
    <div class="sideMenu" id="EmployerSideMenu">
      <a href="#" id="EmployerMenuHome">Dashboard</a>
      <a href="#" id="EmployerMenuPostJob">Post Job</a>
      <a href="#" id="EmployerMenuMyJobs">My Jobs</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
    
    <div class="overlay" id="EmployerOverlay" onclick="toggleEmployerMenu()"></div>
    
    <!-- Employer Home Section -->
    <!-- Replace the Employer Home Section with this: -->
<div class="dashboard-section" id="EmployerHomeSection">
  <h2>Employer Dashboard</h2>
  
  <!-- Quick Stats -->
  <div class="stats-container">
    <div class="stat-card" onclick="showEmployerSection('myJobs')">
      <p>Active Jobs</p>
      <h3 id="EmployerJobCount">-</h3>
    </div>
    <div class="stat-card" onclick="loadApplicationsStats()">
      <p>Total Applications</p>
      <h3 id="EmployerAppCount">-</h3>
    </div>
    <div class="stat-card" onclick="showEmployerSection('myJobs')">
      <p>Total Jobs Posted</p>
      <h3 id="EmployerTotalJobs">-</h3>
    </div>
  </div>
</div>

<!-- Update the Post Job Section with this: -->
<div class="dashboard-section" id="EmployerPostJobSection">
  <h2>Post New Job</h2>
  <button onclick="showEmployerSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
  
  <div class="card">
    <form id="postJobForm">
      <input type="text" id="jobTitle" placeholder="Job Title" required>
      <textarea id="jobDescription" placeholder="Job Description (Responsibilities, Requirements)" required 
                style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; min-height: 120px;"></textarea>
      <input type="text" id="jobLocation" placeholder="Location (e.g., Remote, City)" required>
      <input type="text" id="jobSalary" placeholder="Salary Range (e.g., $50k-$70k)" required>
      <select id="jobType" required>
        <option value="">Select Job Type</option>
        <option value="Full-time">Full-time</option>
        <option value="Part-time">Part-time</option>
        <option value="Contract">Contract</option>
        <option value="Internship">Internship</option>
      </select>
      <button type="submit" class="success">Post Job</button>
    </form>
  </div>
</div>

<!-- Update the My Jobs Section with this: -->
<div class="dashboard-section" id="EmployerMyJobsSection">
  <h2>My Job Postings</h2>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <button onclick="showEmployerSection('home')">‚Üê Back to Dashboard</button>
    <input type="text" class="search-input" placeholder="Search my jobs..." id="searchMyJobs">
  </div>
  
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Applications</th>
          <th>Type</th>
          <th>Posted</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="EmployerJobsTable"></tbody>
    </table>
  </div>
</div>

  <!-- Fresher Dashboard -->

  <div id="fresherDashboard" style="display:none;">

<div id="announcementBannerFresher" class="announcement-banner" style="display: none; cursor: pointer;" onclick="showFullAnnouncement()">
  <div class="scrolling-text" id="announcementTextFresher"></div>
</div>


    <div id="fresherMenuBtn" onclick="toggleFresherMenu()">‚ò∞</div>
    
    <div class="sideMenu" id="fresherSideMenu">
      <a href="#" id="fresherMenuHome">Dashboard</a>
      <a href="#" id="fresherMenuJobs">Browse Jobs</a>
      <a href="#" id="fresherMenuApplications">My Applications</a>
      <a href="#" id="fresherMenuProfile">Profile</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
    
    <div class="overlay" id="fresherOverlay" onclick="toggleFresherMenu()"></div>
    
    <!-- Fresher Home Section -->
    <div class="dashboard-section" id="fresherHomeSection">
      <h2>Fresher Dashboard</h2>
      <div class="card">
        <p>Welcome to your job search dashboard!</p>
      </div>
    </div>
    
    <!-- Browse Jobs Section -->
    <div class="dashboard-section" id="fresherJobsSection">
      <h2>Available Jobs</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Employer</th>
              <th>Location</th>
              <th>Salary</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="availableJobsTable"></tbody>
        </table>
      </div>
    </div>
    
    <!-- My Applications Section -->
    <div class="dashboard-section" id="fresherApplicationsSection">
      <h2>My Applications</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Job Title</th>
              <th>Employer</th>
              <th>Status</th>
              <th>Applied On</th>
            </tr>
          </thead>
          <tbody id="myApplicationsTable"></tbody>
        </table>
      </div>
    </div>
    
    <!-- Profile Section -->
    <div class="dashboard-section" id="fresherProfileSection">
      <h2>My Profile</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="card">
        <form id="fresherProfileForm">
          <input type="text" id="fullName" placeholder="Full Name" required>
          <input type="text" id="education" placeholder="Education" required>
          <textarea id="skills" placeholder="Skills (comma separated)" required style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px;"></textarea>
          <input type="file" id="resume" accept=".pdf,.doc,.docx">
          <button type="submit" class="success">Update Profile</button>
        </form>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { 
    getFirestore, 
    setDoc, 
    doc, 
    getDoc, 
    collection, 
    where, 
    getDocs, 
    query, 
    addDoc, 
    deleteDoc, 
    updateDoc, 
    onSnapshot 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDrrAYywpFdd9iIzSSp2m6XcrGkGUgYY3Y",
    authDomain: "freshershub-33de8.firebaseapp.com",
    projectId: "freshershub-33de8",
    storageBucket: "freshershub-33de8.appspot.com",
    messagingSenderId: "126389629687",
    appId: "1:126389629687:web:9b9fb43e488f60ac3159f2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Global variables
  let roleChangeUnsubscribe = null;
  const ORIGINAL_ADMIN_EMAIL = "gauravku7409@gmail.com";

  // Authentication functions
  window.signup = async function() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;

 // Ensure role matches exactly what rules expect
  const normalizedRole = role === "Employer" ? "Employer" : role.toLowerCase();

    if (!validateEmail(email)) {
      alert("Please enter a valid email address");
      return;
    }

    if (!validatePassword(password)) {
      alert("Password must be at least 8 characters long");
      return;
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      await setDoc(doc(db, "users", user.uid), { 
        email, 
        role: normalizedRole, // Use consistent casing
        createdAt: new Date().toISOString(),
        isOriginalAdmin: email === ORIGINAL_ADMIN_EMAIL
      });

      alert("Signup successful!");
      showDashboard(role);
    } catch (err) {
      alert(err.message);
    }
  };

  window.login = async function() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!validateEmail(email)) {
      alert("Please enter a valid email address");
      return;
    }

    try {
      // Clean up previous listener if exists
      if (roleChangeUnsubscribe) {
        roleChangeUnsubscribe();
      }

      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      const docRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const userData = docSnap.data();

      if (userData.banned) {
        alert("Your account has been banned. Contact support.");
        await signOut(auth);
        return;
      }  

        const initialRole = userData.role;
        showDashboard(initialRole);
        startUserAnnouncementListener();
        startEmployerSignupListener();


        // Set up role change listener
        roleChangeUnsubscribe = onSnapshot(docRef, (snapshot) => {
          const data = snapshot.data();

    if (data?.banned) {
     alert("You have been banned. You are now logged out.");
      logout();
       return;
  }

  const newRole = data?.role;
  if (newRole !== initialRole) {
    alert("Your role has changed. You'll be logged out.");
    logout();
  }
});

      } else {
        alert("User data not found.");
      }
    } catch (err) {
      alert(err.message);
    }
  };


async function startEmployerSignupListener() {
  const currentUser = auth.currentUser;
  if (!currentUser) return;

  const userDoc = await getDoc(doc(db, "users", currentUser.uid));
  const isAdmin = userDoc.exists() && userDoc.data().isOriginalAdmin;
  if (!isAdmin) return;

  let latestEmployerTimestamps = {};

  onSnapshot(collection(db, "users"), (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === "added") {
        const data = change.doc.data();
        if (data.role.toLowerCase() === "Employer") {
          const id = change.doc.id;
          if (!latestEmployerTimestamps[id]) {
            latestEmployerTimestamps[id] = true;
            showAdminToast(`New Employer: ${data.email}`);
          }
        }
      }
    });
  });
}



  window.logout = function() {
    if (roleChangeUnsubscribe) {
      roleChangeUnsubscribe();
      roleChangeUnsubscribe = null;
    }
    
    signOut(auth).then(() => {
      document.getElementById('auth-section').style.display = 'block';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('EmployerDashboard').style.display = 'none';
      document.getElementById('fresherDashboard').style.display = 'none';
    });
  };

  // Form toggle function
  window.toggleForm = function() {
    const formTitle = document.getElementById('form-title');
    const actionBtn = document.getElementById('actionBtn');
    const toggleText = document.getElementById('toggle-text');
    const roleSelect = document.getElementById('role');

    if (formTitle.textContent.includes('Signup')) {
      formTitle.textContent = 'FreshersHub - Login';
      actionBtn.textContent = 'Login';
      actionBtn.onclick = login;
      toggleText.innerHTML = `Don't have an account? <a id="toggleLink">Signup here</a>`;
      roleSelect.style.display = 'none';
    } else {
      formTitle.textContent = 'FreshersHub - Signup';
      actionBtn.textContent = 'Signup';
      actionBtn.onclick = signup;
      toggleText.innerHTML = `Already have an account? <a id="toggleLink">Login here</a>`;
      roleSelect.style.display = 'block';
    }
    
    document.getElementById('toggleLink').addEventListener('click', (e) => {
      e.preventDefault();
      toggleForm();
    });
  };

  // Dashboard functions
  window.showDashboard = function(role) {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('EmployerDashboard').style.display = 'none';
    document.getElementById('fresherDashboard').style.display = 'none';
    
    document.getElementById('adminMenuBtn').style.display = 'none';
    document.getElementById('EmployerMenuBtn').style.display = 'none';
    document.getElementById('fresherMenuBtn').style.display = 'none';

    if (role === 'admin') {
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('adminMenuBtn').style.display = 'block';
      showAdminSection('home');
      loadAdminStats();
      loadRecentActivity();
    } else if (role === 'fresher') {
      document.getElementById('fresherDashboard').style.display = 'block';
      document.getElementById('fresherMenuBtn').style.display = 'block';
      showFresherSection('home');
    } else if (role === 'Employer') {
      document.getElementById('EmployerDashboard').style.display = 'block';
      document.getElementById('EmployerMenuBtn').style.display = 'block';
      showEmployerSection('home');
    }
  };

  // Menu toggle functions
  window.toggleAdminMenu = function() {
    document.getElementById('adminSideMenu').classList.toggle('open');
    document.getElementById('adminOverlay').classList.toggle('show');
  };

  window.toggleEmployerMenu = function() {
    document.getElementById('EmployerSideMenu').classList.toggle('open');
    document.getElementById('EmployerOverlay').classList.toggle('show');
  };

  window.toggleFresherMenu = function() {
    document.getElementById('fresherSideMenu').classList.toggle('open');
    document.getElementById('fresherOverlay').classList.toggle('show');
  };

  // Admin section functions
  window.showAdminSection = function(section) {
    document.getElementById('adminHomeSection').style.display = 'none';
    document.getElementById('adminUsersSection').style.display = 'none';
    document.getElementById('adminJobsSection').style.display = 'none';
    document.getElementById('adminSettingsSection').style.display = 'none';

    if (section === 'home') {
      document.getElementById('adminHomeSection').style.display = 'block';
       loadAdminStats();
       loadRecentActivity(); 
       loadAnnouncement(); // Add this line    
    } else if (section === 'users') {
      document.getElementById('adminUsersSection').style.display = 'block';
      loadAllUsers();
      loadDeletedUsers(); // Add this line to load deleted users
    } else if (section === 'jobs') {
      document.getElementById('adminJobsSection').style.display = 'block';
      loadAllJobs();
    } else if (section === 'settings') {
      document.getElementById('adminSettingsSection').style.display = 'block';
      loadAdminManagement();
      loadBannedUsers(); // Add this line
    }
  };

  window.loadAllUsers = async function() {
    const table = document.getElementById('usersTableBody');
    table.innerHTML = '<tr><td colspan="3">Loading users...</td></tr>';

    try {
      const querySnapshot = await getDocs(collection(db, "users"));
      table.innerHTML = '';

      if (querySnapshot.empty) {
        table.innerHTML = '<tr><td colspan="3">No users found</td></tr>';
        return;
      }

    querySnapshot.forEach(doc => {
    const data = doc.data();
    
    if (data.isOriginalAdmin) return; // üîí Skip original admin

    const row = `
      <tr>
        <td><input type="checkbox" class="user-checkbox" data-id="${doc.id}"></td>
        <td>${data.email}</td>
        <td>${data.role}</td>
        <td>${!data.isOriginalAdmin ? 
          `<button onclick="deleteUser('${doc.id}')" class="danger">Delete</button>` : ''}
        </td>
      </tr>`;
    table.innerHTML += row;
  });
    } catch (error) {
      table.innerHTML = '<tr><td colspan="3">Error loading users</td></tr>';
    }
  };

  window.loadAllJobs = async function() {
    const table = document.getElementById('jobsTableBody');
    table.innerHTML = '<tr><td colspan="6">Loading jobs...</td></tr>';

    try {
      const querySnapshot = await getDocs(collection(db, "jobs"));
      table.innerHTML = '';

      if (querySnapshot.empty) {
        table.innerHTML = '<tr><td colspan="5">No jobs found</td></tr>';
        return;
      }

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const row = `
          <tr>
            <td><input type="checkbox" class="job-checkbox" data-id="${doc.id}"></td>
            <td>${data.Title || 'N/A'}</td>
            <td>${data.Employer || 'N/A'}</td>
            <td>${data.location || 'N/A'}</td>
            <td>${data.salary || 'N/A'}</td>
            <td>
              <button onclick="deleteJob('${doc.id}')" class="danger">Delete</button>
            </td>
          </tr>`;
        table.innerHTML += row;
      });
    } catch (error) {
      table.innerHTML = '<tr><td colspan="5">Error loading jobs</td></tr>';
    }
  };


// Announcement Listener (add this EXACTLY here)

window.startUserAnnouncementListener = function() {
  const announcementRef = doc(db, "announcements", "current");

  onSnapshot(announcementRef, (docSnap) => {
    const data = docSnap.data();
    const text = data?.text?.trim();
    const isActive = !!text;

    // Update Fresher banner
    const fresherBanner = document.getElementById("announcementBannerFresher");
    const fresherText = document.getElementById("announcementTextFresher");
    if (fresherBanner && fresherText) {
      fresherBanner.style.display = isActive ? "block" : "none";
      fresherText.textContent = text || "";
    }

    // Update Employer banner
    const EmployerBanner = document.getElementById("announcementBannerEmployer");
    const EmployerText = document.getElementById("announcementTextEmployer");
    if (EmployerBanner && EmployerText) {
      EmployerBanner.style.display = isActive ? "block" : "none";
      EmployerText.textContent = text || "";
    }
  }, (error) => {
    console.error("Announcement error:", error);
  });
};



//delete users

  window.deleteUser = async function(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;
  
  try {
    const user = auth.currentUser;
    if (!user) throw new Error("Not authenticated");
    
    // Verify admin status
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists() || userDoc.data().role !== "admin") {
      throw new Error("Admin privileges required");
    }

    // Rest of your delete logic...
    const userRef = doc(db, "users", userId);
    const userSnap = await getDoc(userRef);
    
    if (!userSnap.exists()) {
      alert("User not found");
      return;
    }
    
    const userData = userSnap.data();
    
    // First delete from users collection
    await deleteDoc(userRef);
    
    // Then add to deleted_users collection
    await setDoc(doc(db, "deleted_users", userId), {
      email: userData.email,
      role: userData.role,
      deletedAt: new Date().toISOString(),
      deletedBy: user.email,
      originalId: userId // Keep reference to original ID
    });
    
    alert("User moved to deleted users successfully!");
    loadAllUsers();
    loadDeletedUsers();
  } catch (error) {
    console.error("Delete error:", error);
    alert("Error: " + error.message);
  }
};

//confirm full deletion

window.confirmFullDeletion = async function(docId, email) {
  if (!confirm(`Have you already deleted ${email} from Firebase Authentication? This will remove the record completely.`)) {
    return;
  }
  
  try {
    // Remove from deleted_users collection
    await deleteDoc(doc(db, "deleted_users", docId));
    alert("Record cleaned up successfully!");
    loadDeletedUsers();
  } catch (error) {
    alert("Error removing record: " + error.message);
  }
};


//delete jobs

  window.deleteJob = async function(jobId) {
  if (!confirm("Are you sure you want to delete this job?")) return;
  
  try {
    const user = auth.currentUser;
    const userDoc = await getDoc(doc(db, "users", user.uid));
    
    // Verify admin status (original or promoted)
    if (!userDoc.exists() || userDoc.data().role !== "admin") {
      throw new Error("Admin privileges required");
    }

    await deleteDoc(doc(db, "jobs", jobId));
    alert("Job deleted successfully");
    loadAllJobs();
  } catch (error) {
    alert("Error deleting job: " + error.message);
  }
};

  // Admin management functions
  
  window.promoteToAdmin = async function() {
    const email = document.getElementById('promoteEmail').value.trim();
    const currentUser = auth.currentUser;

    if (!email) {
      alert("Please enter a valid email");
      return;
    }

    try {
      // Verify current user is original admin
      const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (!currentUserDoc.data().isOriginalAdmin) {
        alert("Only original admin can promote users");
        return;
      }

      // Find user to promote
      const usersSnapshot = await getDocs(query(
        collection(db, "users"),
        where("email", "==", email)
      ));

      if (usersSnapshot.empty) {
        alert("User not found");
        return;
      }

      const userDoc = usersSnapshot.docs[0];
      const userData = userDoc.data();

      if (userData.role === "admin") {
        alert("User is already an admin");
        return;
      }

      await updateDoc(userDoc.ref, {
        role: "admin"
      });

      alert("User promoted to admin successfully");
      document.getElementById('promoteEmail').value = "";
      loadAdminManagement();
    } catch (err) {
      alert("Error promoting user: " + err.message);
    }
  };

// üîí Ban User by email

// Updated banUser function with proper error handling
window.banUser = async function() {
  const email = document.getElementById('banUserEmail').value.trim();
  if (!email) return alert("Please enter an email");

  try {
    const currentUser = auth.currentUser;
    if (!currentUser) throw new Error("Not authenticated");

    // Check admin status (original or promoted)
    const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (!currentUserDoc.exists() || currentUserDoc.data().role !== "admin") {
      throw new Error("Admin privileges required");
    }

    // Find user to ban
    const userToBanQuery = query(collection(db, "users"), where("email", "==", email));
    const querySnapshot = await getDocs(userToBanQuery);
    
    if (querySnapshot.empty) {
      alert("User not found");
      return;
    }

    const userDoc = querySnapshot.docs[0];
    const userData = userDoc.data();

    // Prevent banning original admin
    if (userData.isOriginalAdmin) {
      throw new Error("Cannot ban original admin");
    }

    // Prepare update data - MUST match exactly what rules expect
    const updateData = {
      banned: true,
      bannedAt: new Date().toISOString(),
      bannedBy: currentUser.email
    };

    // Perform the update
    await setDoc(userDoc.ref, updateData, { merge: true });


    alert(`User ${email} has been banned`);
    document.getElementById('banUserEmail').value = "";
    loadBannedUsers();
  } catch (error) {
    console.error("Ban error:", error);
    alert(`Error: ${error.message}`);
    
    // Special guidance for permission errors
    if (error.code === "permission-denied") {
      alert("Please verify: 1) You're admin 2) Only updating ban fields");
    }
  }
};


function showBanFeedback(message, isError = false) {
  const feedbackDiv = document.getElementById('banUserFeedback');
  feedbackDiv.textContent = message;
  feedbackDiv.style.color = isError ? 'red' : 'green';
  feedbackDiv.style.display = 'block';
  
  setTimeout(() => {
    feedbackDiv.style.display = 'none';
  }, 5000);
}


// üì¢ Post announcement
window.postAnnouncementV2 = async function(text) {
  if (!text || text.trim() === "") {
    alert("Please enter announcement text");
    return;
  }

  try {
    const user = auth.currentUser;
    if (!user) throw new Error("Not authenticated");

    // Get user document
    const userDocRef = doc(db, "users", user.uid);
    const userDoc = await getDoc(userDocRef);
    if (!userDoc.exists()) throw new Error("User not found");

    const userData = userDoc.data();

    // Ensure only original admin can post
    if (!userData.isOriginalAdmin) {
      throw new Error("Only original admin can post announcements");
    }

    // Format role (Admin, Employer, etc.)
    const authorRole = userData.role
      ? userData.role.charAt(0).toUpperCase() + userData.role.slice(1)
      : "Admin";

    // Save announcement with role
    console.log("Author being saved:", authorRole);

    await setDoc(doc(db, "announcements", "current"), {
      text: text.trim(),
      timestamp: new Date().toISOString(),
      author: authorRole,
      authorId: user.uid
    });

    alert("Announcement posted successfully!");
    loadAnnouncement(); // Refresh announcement display

  } catch (err) {
    console.error("Announcement error:", err);
    alert(`Failed to post announcement: ${err.message}`);
  }
};


  //revokeadmin

  window.revokeAdmin = async function(userId) {
    const currentUser = auth.currentUser;

    if (!confirm("Are you sure you want to revoke admin rights?")) return;

    try {
      // Verify current user is original admin
      const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (!currentUserDoc.data().isOriginalAdmin) {
        alert("Only original admin can revoke admin rights");
        return;
      }

      // Verify not revoking self
      if (userId === currentUser.uid) {
        alert("Cannot revoke your own admin rights");
        return;
      }

      await updateDoc(doc(db, "users", userId), {
        role: "fresher"
      });

      alert("Admin rights revoked successfully");
      loadAdminManagement();
    } catch (err) {
      alert("Error revoking admin rights: " + err.message);
    }
  };

  window.loadAdminManagement = async function() {
    const table = document.getElementById('adminTableBody');
    table.innerHTML = '<tr><td colspan="2">Loading admins...</td></tr>';

    try {
      const currentUser = auth.currentUser;
      const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
      const isOriginalAdmin = currentUserDoc.data().isOriginalAdmin;

      // Show/hide promote section based on permissions
      document.getElementById('addAdminSection').style.display = 
        isOriginalAdmin ? "block" : "none";

      // Load admin list
      const querySnapshot = await getDocs(query(
        collection(db, "users"),
        where("role", "==", "admin")
      ));

      table.innerHTML = '';
      querySnapshot.forEach(doc => {
    const data = doc.data();
    const isCurrentUser = doc.id === currentUser.uid;
    const isTargetOriginalAdmin = data.isOriginalAdmin;
    
    let adminType = "";
    if (data.isOriginalAdmin) {
      adminType = " (Original Admin)";
    } else if (data.role === "admin") {
      adminType = " (Promoted Admin)";
    }

    let actionCell = "-";
    if (isOriginalAdmin && !isTargetOriginalAdmin && !isCurrentUser) {
      actionCell = `<button onclick="revokeAdmin('${doc.id}')" class="danger">Revoke</button>`;
    }

    const row = `
      <tr>
        <td>${data.email}${adminType}</td>
        <td>${actionCell}</td>
      </tr>`;
    table.innerHTML += row;
  });

      if (table.innerHTML === '') {
        table.innerHTML = '<tr><td colspan="2">No admins found</td></tr>';
      }
    } catch (err) {
      table.innerHTML = '<tr><td colspan="2">Error loading admins</td></tr>';
    }
  };

//loadEmployerstats

// Add to your existing JavaScript
window.loadEmployerStats = async function() {
  try {
    const user = auth.currentUser;
    if (!user) return;

    // Count Employer's jobs
    const jobsQuery = query(
      collection(db, "jobs"),
      where("Employer", "==", user.email)
    );
    const jobsSnapshot = await getDocs(jobsQuery);
    document.getElementById('EmployerJobCount').textContent = jobsSnapshot.size;

    // Count applications (placeholder - will implement later)
    document.getElementById('EmployerAppCount').textContent = "0";
  } catch (error) {
    console.error("Error loading stats:", error);
  }
};


window.loadEmployerJobs = function() {
  const table = document.getElementById('EmployerJobsTable');
  const user = auth.currentUser;

  // Clear existing listener
  if (jobsListener) jobsListener();

  // Show loading state
  table.innerHTML = '<tr><td colspan="6">Loading jobs...</td></tr>';

  // Set up real-time listener with proper field name
  jobsListener = onSnapshot(
    query(
      collection(db, "jobs"),
      where("EmployerId", "==", user.uid), // Make sure this matches your data
      orderBy("createdAt", "desc")
    ),
    (snapshot) => {
      try {
        if (snapshot.empty) {
          table.innerHTML = '<tr><td colspan="6">No jobs posted yet</td></tr>';
          return;
        }

        table.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = `
            <tr>
              <td>${data.Title || 'Untitled'}</td>
              <td>${data.applications?.length || 0}</td>
              <td>${data.jobType || 'N/A'}</td>
              <td>${new Date(data.createdAt).toLocaleDateString()}</td>
              <td><span class="job-status">${data.status || 'active'}</span></td>
              <td>
                <button onclick="viewJobApplications('${doc.id}')" class="success">View</button>
                <button onclick="editJob('${doc.id}')">Edit</button>
                <button onclick="deleteJob('${doc.id}')" class="danger">Delete</button>
              </td>
            </tr>`;
          table.innerHTML += row;
        });
      } catch (error) {
        console.error("Error processing snapshot:", error);
        table.innerHTML = '<tr><td colspan="6">Error loading jobs</td></tr>';
      }
    },
    (error) => {
      console.error("Listener error:", error);
      table.innerHTML = '<tr><td colspan="6">Error loading jobs</td></tr>';
    }
  );
};

// Call this when switching away from jobs view
function cleanupJobsListener() {
  if (jobsListener) {
    jobsListener();
    jobsListener = null;
  }
}


    // Add search functionality
document.getElementById('searchMyJobs').addEventListener('input', (e) => {
  const term = e.target.value.toLowerCase();
  const table = document.getElementById('EmployerJobsTable'); // Make sure this matches your table ID
  const rows = table.querySelectorAll('tr');

  try {
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(term) ? '' : 'none';
    });
  } catch (error) {
    console.error("Search error:", error);
    // Show error without breaking the UI
    const errorRow = document.createElement('tr');
    errorRow.innerHTML = '<td colspan="6" style="color: red;">Search failed</td>';
    table.appendChild(errorRow);
  }
});

// Enhanced post job function

window.postJob = async function(e) {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = "Posting...";

  try {
    const user = auth.currentUser;
    if (!user) throw new Error("Not authenticated");

    // ‚ö†Ô∏è Key fix: Ensure these fields EXACTLY match Firestore rules
    await addDoc(collection(db, "jobs"), {
      Title: document.getElementById('jobTitle').value,
      description: document.getElementById('jobDescription').value,
      location: document.getElementById('jobLocation').value,
      salary: document.getElementById('jobSalary').value,
      jobType: document.getElementById('jobType').value,
      EmployerId: user.uid, // üî• Must match Firestore rules (case-sensitive)
      createdAt: new Date().toISOString(), // üî• Required by rules
      status: "active",
      applications: []
    });

    showEmployerSection('myJobs');
  } catch (error) {
    alert(`Error: ${error.message}`);
    console.error("Full error:", error);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "Post Job";
  }
};
// Enhanced loadEmployerStats function

window.loadEmployerStats = async function() {
  try {
    const user = auth.currentUser;
    if (!user) return;

    // Count Employer's ACTIVE jobs (existing)
    const activeJobsQuery = query(
      collection(db, "jobs"),
      where("EmployerId", "==", user.uid),
      where("status", "==", "active")
    );
    const activeJobsSnapshot = await getDocs(activeJobsQuery);
    document.getElementById('EmployerJobCount').textContent = activeJobsSnapshot.size;

    // NEW: Count ALL jobs (including inactive/closed)
    const totalJobsQuery = query(
      collection(db, "jobs"),
      where("EmployerId", "==", user.uid)
    );
    const totalJobsSnapshot = await getDocs(totalJobsQuery);
    document.getElementById('EmployerTotalJobs').textContent = totalJobsSnapshot.size;

    // Count applications (placeholder - implement later)
    document.getElementById('EmployerAppCount').textContent = "0";

  } catch (error) {
    console.error("Error loading stats:", error);
    // Show errors in UI
    document.getElementById('EmployerJobCount').textContent = "Error";
    document.getElementById('EmployerTotalJobs').textContent = "Error";
    document.getElementById('EmployerAppCount').textContent = "Error";
  }
};

// Initialize Employer dashboard

window.initEmployerDashboard = async function() {
  try {
    // Load stats
    await loadEmployerStats();
    
    // Load jobs
    await loadEmployerJobs();
    
    // Set up form listeners
   document.getElementById('postJobForm').addEventListener('submit', async (e) => {
  await postJob(e);
  // Form reset after successful submission
  e.target.reset();
});
    
    // Add search functionality
    document.getElementById('searchMyJobs')?.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const table = document.getElementById('EmployerJobsTable');
      const rows = table?.querySelectorAll('tr');
      rows?.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    });
  } catch (error) {
    console.error("Error initializing Employer dashboard:", error);
  }
};



  // Stats and activity functions
  async function loadAdminStats() {
    try {
      // Count Freshers
      const freshersQuery = query(collection(db, "users"), where("role", "==", "fresher"));
      const freshersSnapshot = await getDocs(freshersQuery);
      animateValue("totalFreshers", freshersSnapshot.size);

      // Count Employers
      const EmployersQuery = query(collection(db, "users"), where("role", "==", "Employer"));
      const EmployersSnapshot = await getDocs(EmployersQuery);
      animateValue("totalEmployers", EmployersSnapshot.size);

      // Count Jobs
      const jobsSnapshot = await getDocs(collection(db, "jobs"));
      animateValue("totalJobs", jobsSnapshot.size);
    } catch (error) {
      console.error("Error loading stats:", error);
    }
  }

  async function loadRecentActivity() {
    try {
      // Recent Users
      const usersQuery = query(collection(db, "users"), where("role", "in", ["fresher", "Employer"]));
      const usersSnapshot = await getDocs(usersQuery);
      
      const usersData = [];
      usersSnapshot.forEach(doc => usersData.push({ id: doc.id, ...doc.data() }));
      
      usersData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      const last5Users = usersData.slice(0, 5);
      
      const usersTable = document.getElementById('recentUsersTable');
      usersTable.innerHTML = "";
      last5Users.forEach(user => {
        usersTable.innerHTML += `<tr><td>${user.email}</td><td>${user.role}</td></tr>`;
      });

      // Recent Jobs
      const jobsSnapshot = await getDocs(collection(db, "jobs"));
      const jobsData = [];
      jobsSnapshot.forEach(doc => jobsData.push({ id: doc.id, ...doc.data() }));

      jobsData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      const last5Jobs = jobsData.slice(0, 5);
      
      const jobsTable = document.getElementById('recentJobsTable');
      jobsTable.innerHTML = "";
      last5Jobs.forEach(job => {
        jobsTable.innerHTML += `
          <tr>
            <td>${job.Title || 'N/A'}</td>
            <td>${job.Employer || 'N/A'}</td>
            <td>${job.location || 'N/A'}</td>
          </tr>`;
      });
    } catch (error) {
      console.error("Error loading recent activity:", error);
    }
  }

//loadannouncements

function loadAnnouncement() {
  const announcementRef = doc(db, "announcements", "current");
  const announcementDiv = document.getElementById("currentAnnouncement");
  const actionsDiv = document.getElementById("announcementActions");

  onSnapshot(announcementRef, async (announcementSnap) => {
    if (announcementSnap.exists()) {
      const data = announcementSnap.data();
      announcementDiv.innerHTML = `
        <p style="margin-bottom: 8px;"><strong>${data.text || "No text"}</strong></p>
        <small>Posted by ${data.author || "Admin"} on ${data.timestamp ? new Date(data.timestamp).toLocaleString() : "Unknown date"}</small>
      `;

      // Only show actions if original admin
      const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
      actionsDiv.style.display = userDoc.exists() && userDoc.data().isOriginalAdmin ? "block" : "none";
    } else {
      announcementDiv.innerHTML = "No active announcements.";
      actionsDiv.style.display = "none";
    }
  }, (err) => {
    console.error("Live announcement error:", err);
    announcementDiv.innerHTML = "Failed to load announcement.";
    actionsDiv.style.display = "none";
  });
}




  //show announcement modal

window.showAnnouncementModal = async function() {
  const user = auth.currentUser;
  const userDoc = await getDoc(doc(db, "users", user.uid));

  if (!userDoc.data().isOriginalAdmin) {
    alert("Only original admin can post announcements");
    return;
  }

  const text = prompt("Enter announcement text:");
  if (text) {
    try {
      const userData = userDoc.data();
      const authorRole = userData.role.charAt(0).toUpperCase() + userData.role.slice(1);

      await setDoc(doc(db, "announcements", "current"), {
        text: text,
        timestamp: new Date().toISOString(),
        author: authorRole
      });

      alert("Announcement posted!");
    } catch (err) {
      alert("Error: " + err.message);
    }
  }
};


// delete announcements

window.deleteAnnouncement = async function() {
  if (!confirm("Are you sure you want to delete the current announcement?")) return;

  try {
    await deleteDoc(doc(db, "announcements", "current"));
    alert("Announcement deleted.");
    loadAnnouncement();
  } catch (err) {
    console.error("Delete error:", err);
    alert("Failed to delete announcement: " + err.message);
  }
};

//showfullannouncement

window.showFullAnnouncement = async function() {
  const snap = await getDoc(doc(db, "announcements", "current"));
  const data = snap.exists() ? snap.data() : null;
  const fullText = data?.text || "No announcement.";

  alert("üì¢ Announcement:\n\n" + fullText);
};


// Unban user
window.unbanUser = async function(userId) {
  if (!confirm("Are you sure you want to unban this user?")) return;
  
  try {
    await updateDoc(doc(db, "users", userId), { 
      banned: false,
      bannedAt: null
    });
    alert("User unbanned successfully");
    loadBannedUsers();
  } catch (err) {
    console.error("Error unbanning user:", err);
    alert("Error unbanning user: " + err.message);
  }
};

// Load banned users
async function loadBannedUsers() {
  try {
    const bannedUsersQuery = query(
      collection(db, "users"),
      where("banned", "==", true)
    );
    const bannedUsersSnapshot = await getDocs(bannedUsersQuery);
    
    const table = document.getElementById("bannedUsersTable");
    table.innerHTML = "";
    
    if (bannedUsersSnapshot.empty) {
      table.innerHTML = "<tr><td colspan='3'>No banned users found</td></tr>";
      return;
    }
    
    bannedUsersSnapshot.forEach(doc => {
      const userData = doc.data();
      table.innerHTML += `
        <tr>
          <td>${userData.email}</td>
          <td>${userData.bannedAt ? new Date(userData.bannedAt).toLocaleString() : 'N/A'}</td>
          <td><button onclick="unbanUser('${doc.id}')" class="success">Unban</button></td>
        </tr>`;
    });
  } catch (err) {
    console.error("Error loading banned users:", err);
    document.getElementById("bannedUsersTable").innerHTML = 
      "<tr><td colspan='3'>Error loading banned users</td></tr>";
  }
}


  // Employer section functions
  window.showEmployerSection = function(section) {
    document.getElementById('EmployerHomeSection').style.display = 'none';
    document.getElementById('EmployerPostJobSection').style.display = 'none';
    document.getElementById('EmployerMyJobsSection').style.display = 'none';

    if (section === 'home') {
      document.getElementById('EmployerHomeSection').style.display = 'block';
    } else if (section === 'postJob') {
      document.getElementById('EmployerPostJobSection').style.display = 'block';
    } else if (section === 'myJobs') {
      document.getElementById('EmployerMyJobsSection').style.display = 'block';
      loadEmployerJobs();
    }
  };

  // Fresher section functions
  window.showFresherSection = function(section) {
    document.getElementById('fresherHomeSection').style.display = 'none';
    document.getElementById('fresherJobsSection').style.display = 'none';
    document.getElementById('fresherApplicationsSection').style.display = 'none';
    document.getElementById('fresherProfileSection').style.display = 'none';

    if (section === 'home') {
      document.getElementById('fresherHomeSection').style.display = 'block';
    } else if (section === 'jobs') {
            document.getElementById('fresherJobsSection').style.display = 'block';
      loadAvailableJobs();
    } else if (section === 'applications') {
      document.getElementById('fresherApplicationsSection').style.display = 'block';
      loadMyApplications();
    } else if (section === 'profile') {
      document.getElementById('fresherProfileSection').style.display = 'block';
      loadFresherProfile();
    }
  };

  // Validation functions
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  function validatePassword(password) {
    return password.length >= 8;
  }

  // Utility functions
  function animateValue(element, target, duration = 1000) {
    const start = 0;
    const increment = target / (duration / 16);
    let current = start;
    const el = document.getElementById(element);
    const timer = setInterval(() => {
      current += increment;
      if (current >= target) {
        clearInterval(timer);
        current = target;
      }
      el.textContent = Math.floor(current);
    }, 16);
  }

  // Placeholder functions (to be implemented)
  window.loadEmployerJobs = function() {
    document.getElementById('EmployerJobsTable').innerHTML = `
      <tr><td colspan="4">Job listings will appear here</td></tr>`;
  };

  window.loadAvailableJobs = function() {
    document.getElementById('availableJobsTable').innerHTML = `
      <tr><td colspan="5">Available jobs will appear here</td></tr>`;
  };

  window.loadMyApplications = function() {
    document.getElementById('myApplicationsTable').innerHTML = `
      <tr><td colspan="4">Your applications will appear here</td></tr>`;
  };

  window.loadFresherProfile = function() {
    // Would load profile data here
  };

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Toggle between login/signup forms
    document.getElementById('toggleLink').addEventListener('click', (e) => {
      e.preventDefault();
      toggleForm();
    });

    // Admin menu navigation
    document.getElementById('adminMenuHome').addEventListener('click', (e) => {
      e.preventDefault();
      showAdminSection('home');
      toggleAdminMenu();
    });

    document.getElementById('adminMenuUsers').addEventListener('click', (e) => {
      e.preventDefault();
      showAdminSection('users');
      toggleAdminMenu();
    });

    document.getElementById('adminMenuJobs').addEventListener('click', (e) => {
      e.preventDefault();
      showAdminSection('jobs');
      toggleAdminMenu();
    });

    document.getElementById('adminMenuSettings').addEventListener('click', (e) => {
      e.preventDefault();
      showAdminSection('settings');
      toggleAdminMenu();
    });

    // Employer menu navigation
    document.getElementById('EmployerMenuHome').addEventListener('click', (e) => {
      e.preventDefault();
      showEmployerSection('home');
      toggleEmployerMenu();
    });

    document.getElementById('EmployerMenuPostJob').addEventListener('click', (e) => {
      e.preventDefault();
      showEmployerSection('postJob');
      toggleEmployerMenu();
    });

    document.getElementById('EmployerMenuMyJobs').addEventListener('click', (e) => {
      e.preventDefault();
      showEmployerSection('myJobs');
      toggleEmployerMenu();
    });

    // Fresher menu navigation
    document.getElementById('fresherMenuHome').addEventListener('click', (e) => {
      e.preventDefault();
      showFresherSection('home');
      toggleFresherMenu();
    });

    document.getElementById('fresherMenuJobs').addEventListener('click', (e) => {
      e.preventDefault();
      showFresherSection('jobs');
      toggleFresherMenu();
    });

    document.getElementById('fresherMenuApplications').addEventListener('click', (e) => {
      e.preventDefault();
      showFresherSection('applications');
      toggleFresherMenu();
    });

    document.getElementById('fresherMenuProfile').addEventListener('click', (e) => {
      e.preventDefault();
      showFresherSection('profile');
      toggleFresherMenu();
    });

    // Post Job Form submission
    const postJobForm = document.getElementById('postJobForm');
    if (postJobForm) {
      postJobForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('jobTitle').value;
        const description = document.getElementById('jobDescription').value;
        const location = document.getElementById('jobLocation').value;
        const salary = document.getElementById('jobSalary').value;
        
        try {
          const user = auth.currentUser;
          if (!user) throw new Error("Not authenticated");
          
          await addDoc(collection(db, "jobs"), {
            Title: title,
            description: description,
            location: location,
            salary: salary,
            Employer: user.email,
            createdAt: new Date().toISOString()
          });
          
          alert("Job posted successfully!");
          postJobForm.reset();
        } catch (error) {
          alert("Error posting job: " + error.message);
        }
      });
    }

    // Profile Form submission
    const profileForm = document.getElementById('fresherProfileForm');
    if (profileForm) {
      profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        alert("Profile updated successfully!");
      });
    }

    // Auth state change handler
    onAuthStateChanged(auth, async (user) => {
  if (!user) {
    document.getElementById('auth-section').style.display = 'block';
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      const userData = userDoc.data();

      if (userData.banned) {
        alert("Your account has been banned.");
        await signOut(auth);
        return;
      }

      showDashboard(userData.role);
      startUserAnnouncementListener();
      startEmployerSignupListener();

      //Initialize listeners
 if (typeof startUserAnnouncementListener === 'function') {
        startUserAnnouncementListener(); // Now safely called
      }
      

      // Initialize role-specific dashboard components
      if (userData.role === 'admin') {
        loadAdminStats();
        loadRecentActivity();
        loadAnnouncement();
      } else if (userData.role === 'Employer') {
        initEmployerDashboard(); // Initialize Employer-specific features
      } else if (userData.role === 'fresher') {
        // Initialize fresher-specific features if needed
      }

      // Set up role change listener
      if (roleChangeUnsubscribe) {
        roleChangeUnsubscribe();
      }
      
      roleChangeUnsubscribe = onSnapshot(userDoc.ref, (snapshot) => {
        const newData = snapshot.data();
        if (newData?.banned) {
          alert("Your account has been banned. You are now logged out.");
          logout();
          return;
        }
        
        const newRole = newData?.role;
        if (newRole !== userData.role) {
          alert("Your role has changed. Please log in again.");
          logout();
        }
      });
    }
  } catch (error) {
    console.error("Error checking user role:", error);
    alert("Error loading user data. Please try again.");
  }
});

document.addEventListener('DOMContentLoaded', () => {
  // Password Toggle
  const toggleBtn = document.getElementById('togglePasswordBtn');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      const passwordInput = document.getElementById('password');
      if (passwordInput) {
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
      }
    });
  }

  // Search Tables
  document.addEventListener('input', (e) => {
    if (e.target?.classList?.contains('search-input')) {
      const searchTerm = e.target.value.toLowerCase();
      const tableId = e.target.getAttribute('data-table-target');
      const rows = document.querySelectorAll(`#${tableId} tr`);
      
      rows?.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
      });
    }
  });
});

function startUserAnnouncementListener() {
  const announcementRef = doc(db, "announcements", "current");

  onSnapshot(announcementRef, (docSnap) => {
    const data = docSnap.data();
    console.log("Live announcement received:", data);  // üëà Add this

    const text = data?.text?.trim();
    const isActive = !!text;

    // Fresher
    const fresherBanner = document.getElementById("announcementBannerFresher");
    const fresherText = document.getElementById("announcementTextFresher");
    if (fresherBanner && fresherText) {
      fresherBanner.style.display = isActive ? "block" : "none";
      fresherText.textContent = text || "";
    }

    // Employer
    const EmployerBanner = document.getElementById("announcementBannerEmployer");
    const EmployerText = document.getElementById("announcementTextEmployer");
    if (EmployerBanner && EmployerText) {
      EmployerBanner.style.display = isActive ? "block" : "none";
      EmployerText.textContent = text || "";
    }
  });
}

function showAdminToast(message) {
  const toast = document.getElementById('adminToast');
  toast.innerText = message;
  toast.style.display = 'block';
  toast.style.opacity = '1';

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 500);
  }, 4000);
}

//loaddeletedusers

async function loadDeletedUsers() {
  try {
    const querySnapshot = await getDocs(collection(db, "deleted_users"));
    const table = document.getElementById('deletedUsersTable');
    table.innerHTML = '';
    
    if (querySnapshot.empty) {
      table.innerHTML = '<tr><td colspan="3">No deleted users yet</td></tr>';
      return;
    }
    
    querySnapshot.forEach(doc => {
      const data = doc.data();
      const firebaseAuthLink = `https://console.firebase.google.com/u/0/project/${firebaseConfig.projectId}/authentication/users`;
      
      table.innerHTML += `
        <tr>
          <td>
            <a href="${firebaseAuthLink}" target="_blank" 
               style="color: #00c6ff; text-decoration: underline;">
              ${data.email}
            </a>
          </td>
          <td>${new Date(data.deletedAt).toLocaleString()}</td>
          <td>
            <button onclick="confirmFullDeletion('${doc.id}', '${data.email}')" 
                    class="danger" style="padding: 5px 10px;">
              Confirm Deletion
            </button>
          </td>
        </tr>`;
    });
  } catch (error) {
    console.error("Error loading deleted users:", error);
    document.getElementById('deletedUsersTable').innerHTML = 
      '<tr><td colspan="3">Error loading deleted users</td></tr>';
  }
}
})

</script>

<!-- üîî Admin Notification Toast -->
<div id="adminToast" style="
  display: none;
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #ffc107;
  color: black;
  padding: 12px 20px;
  border-radius: 8px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 9999;
  transition: opacity 0.4s ease;
"></div>

  
</body>
</html>
