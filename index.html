<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FreshersHub</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom right, rgba(0, 114, 255, 0.6), rgba(0, 198, 255, 0.6)),
        url('https://images.unsplash.com/photo-1519389950473-47ba0277781c?fit=crop&w=1650&q=80') no-repeat center center;
      background-size: cover;
      background-attachment: fixed;
      color: white;
    }

    .container {
      max-width: 400px;
      margin: 5% auto;
      padding: 2rem;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }

    h2 { text-align: center; margin-bottom: 1.5rem; }

    input, select, button {
      width: 100%; padding: 12px; margin: 8px 0;
      border: none; border-radius: 8px; font-size: 1rem;
    }

    button { 
      background-color: #00c6ff; 
      color: white; 
      cursor: pointer; 
      transition: background 0.3s;
    }
    button:hover { background-color: #1c78e9; }
    button.danger { background-color: #dc3545; }
    button.danger:hover { background-color: #c82333; }
    button.success { background-color: #28a745; }
    button.success:hover { background-color: #218838; }

    /* Dashboard Cards */
    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      backdrop-filter: blur(5px);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      margin: 20px 0;
      background: white;
      border-radius: 10px;
      color: black;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }

    /* Menu buttons */
    #adminMenuBtn, #fresherMenuBtn, #EmployerMenuBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 28px;
      cursor: pointer;
      z-index: 1001;
      display: none;
      color: white;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      text-align: center;
      line-height: 40px;
    }

    /* Side Menus */
    .sideMenu {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background: rgba(0,0,0,0.9);
      color: white;
      padding-top: 60px;
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    
    .sideMenu.open { transform: translateX(250px); }
    
    .sideMenu a {
      display: block;
      color: white;
      padding: 12px 20px;
      text-decoration: none;
      font-size: 18px;
      border-left: 4px solid transparent;
    }
    
    .sideMenu a:hover {
      background: rgba(255,255,255,0.1);
      border-left: 4px solid #00c6ff;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      display: none;
    }
    
    .overlay.show { display: block; }

    #toggle-text a {
      color: #00aeff; 
      font-weight: bold;
      text-decoration: underline;
      cursor: pointer;
    }

    /* Dashboard sections */
    .dashboard-section {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .stats-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    
     /* New: Horizontal variation (add this) */
    .stats-container.horizontal {
       flex-wrap: nowrap; /* Force horizontal layout */
       overflow-x: auto; /* Enable scrolling if needed */
       padding-bottom: 10px; /* Space for scrollbar */
    }

    .stat-card {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      width: 200px;
      text-align: center;
      backdrop-filter: blur(5px);
    }
    
    .stat-card h3 {
      margin-top: 10px;
      font-size: 2rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .stats-container {
    flex-direction: row; /* Horizontal scroll on mobile */
    justify-content: flex-start; /* Align cards to start */
    }
     .stat-card {
      min-width: 180px; /* Better for scrolling */
     }
     }

  .stat-card h3 {
  margin-top: 10px;
  font-size: 2rem;
  transition: transform 0.3s ease;
}

.stat-card:hover h3 {
  transform: scale(1.1);
  color: #00c6ff;
}

.settings-link {
  padding: 15px;
  margin: 15px 0;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  border-left: 4px solid #00c6ff;
}

.settings-link:hover {
  background: rgba(255,255,255,0.2);
  transform: translateX(5px);
}

.settings-link h4 {
  color: #023c4d;
  margin: 0;
  font-size: 1.2em;
  display: flex;
  align-items: center;
}

.settings-link h4::before {
  content: "→";
  margin-right: 10px;
  font-size: 1.5em;
}


  </style>
</head>
<body>

  <!-- LOGIN/SIGNUP SECTION -->
  <div class="container" id="auth-section" style="display: block;">
    <h2 id="form-title">FreshersHub - Signup</h2>
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <select id="role">
      <option value="fresher">Fresher</option>
      <option value="Employer">Employer</option>
      
    </select>
    <button id="actionBtn" onclick="signup()">Signup</button>
    <p id="toggle-text">Already have an account? <a id="toggleLink">Login here</a></p>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" style="display:none;">
    <div id="adminMenuBtn" onclick="toggleAdminMenu()">☰</div>

    <div class="sideMenu" id="adminSideMenu">
      <a href="#" id="adminMenuHome">Dashboard</a>
      <a href="#" id="adminMenuUsers">Manage Users</a>
      <a href="#" id="adminMenuJobs">Manage Jobs</a>
      <a href="#" id="adminMenuSettings">Settings</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>

    <div class="overlay" id="adminOverlay" onclick="toggleAdminMenu()"></div>

    <!-- Admin Home Section -->
    <div class="dashboard-section" id="adminHomeSection">
      <h2>Admin Dashboard</h2>
      
      <div class="stats-container horizontal">
        <div class="stat-card">
          <p>Total Freshers</p>
          <h3 id="totalFreshers">-</h3>
        </div>
        <div class="stat-card">
          <p>Total Employers</p>
          <h3 id="totalEmployers">-</h3>
        </div>
        <div class="stat-card">
          <p>Total Jobs</p>
          <h3 id="totalJobs">-</h3>
        </div>
      </div>

      <div class="card">
        <h3 style="text-align: center;">Recent Activity</h3>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
          <!-- Recent Users Table -->
          <div style="flex: 1; min-width: 300px;">
            <h4>Last 5 Users</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr><th>Email</th><th>Role</th></tr>
                </thead>
                <tbody id="recentUsersTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Recent Jobs Table -->
          <div style="flex: 1; min-width: 300px;">
            <h4>Last 5 Jobs</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Employer</th>
                    <th>Location</th>
                  </tr>
                </thead>
                <tbody id="recentJobsTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Manage Users Section -->
    <div class="dashboard-section" id="adminUsersSection">
      <h2>Manage Users</h2>
      <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">← Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Rows will be added here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Manage Jobs Section -->
    <div class="dashboard-section" id="adminJobsSection">
      <h2>Manage Job Listings</h2>
      <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">← Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Employer</th>
              <th>Location</th>
              <th>Salary</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="jobsTableBody">
            <!-- Job rows will be added here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Settings Section -->
    <div class="dashboard-section" id="adminSettingsSection">
      <h2>Admin Settings</h2>
      <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">← Back to Dashboard</button>
      
      <div class="card">
        <h3>System configurations</h3>

         <!-- Add this Admin Management link -->
      <div class="settings-link" onclick="showAdminSection('management')">
        <h4>→ Admin Management</h4>
      </div>
    </div>
  </div>

    <!-- Admin Management Section -->
<div class="dashboard-section" id="adminManagementSection" style="display:none;">
  <h2>Admin Management</h2>
  <button onclick="showAdminSection('settings')" style="margin-bottom: 20px;">← Back to Settings</button>
  
  <div class="card">
    <h3>Add New Admin</h3>
    <div class="form-group">
      <input type="email" id="newAdminEmail" placeholder="Admin email address">
      <input type="password" id="newAdminPassword" placeholder="Temporary password">
      <button onclick="createNewAdmin()" class="success">Create Admin</button>
    </div>
    <p class="hint">New admin will receive password reset instructions</p>
  </div>

  <div class="card">
    <h3>Current Admins</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Created On</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="adminListTable"></tbody>
      </table>
    </div>
  </div>
</div>


  <!-- Employer DASHBOARD -->
  <div id="EmployerDashboard" style="display:none;">
    <div id="EmployerMenuBtn" onclick="toggleEmployerMenu()">☰</div>
    
    <div class="sideMenu" id="EmployerSideMenu">
      <a href="#" id="EmployerMenuHome">Dashboard</a>
      <a href="#" id="EmployerMenuPostJob">Post Job</a>
      <a href="#" id="EmployerMenuMyJobs">My Jobs</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
    
    <div class="overlay" id="EmployerOverlay" onclick="toggleEmployerMenu()"></div>
    
    <!-- Employer Home Section -->
    <div class="dashboard-section" id="EmployerHomeSection">
      <h2>Employer Dashboard</h2>
      <div class="card">
        <p>Welcome to your Employer dashboard!</p>
      </div>
    </div>
    
    <!-- Post Job Section -->
    <div class="dashboard-section" id="EmployerPostJobSection">
      <h2>Post New Job</h2>
      <button onclick="showEmployerSection('home')" style="margin-bottom: 20px;">← Back to Dashboard</button>
      
      <div class="card">
        <form id="postJobForm">
          <input type="text" id="jobTitle" placeholder="Job Title" required>
          <textarea id="jobDescription" placeholder="Job Description" required style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px;"></textarea>
          <input type="text" id="jobLocation" placeholder="Location" required>
          <input type="text" id="jobSalary" placeholder="Salary Range" required>
          <button type="submit" class="success">Post Job</button>
        </form>
      </div>
    </div>
    
    <!-- My Jobs Section -->
    <div class="dashboard-section" id="EmployerMyJobsSection">
      <h2>My Job Postings</h2>
      <button onclick="showEmployerSection('home')" style="margin-bottom: 20px;">← Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Applications</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="EmployerJobsTable">
            <!-- Employer's jobs will be listed here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- FRESHER DASHBOARD -->
  <div id="fresherDashboard" style="display:none;">
    <div id="fresherMenuBtn" onclick="toggleFresherMenu()">☰</div>
    
    <div class="sideMenu" id="fresherSideMenu">
      <a href="#" id="fresherMenuHome">Dashboard</a>
      <a href="#" id="fresherMenuJobs">Browse Jobs</a>
      <a href="#" id="fresherMenuApplications">My Applications</a>
      <a href="#" id="fresherMenuProfile">Profile</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
    
    <div class="overlay" id="fresherOverlay" onclick="toggleFresherMenu()"></div>
    
    <!-- Fresher Home Section -->
    <div class="dashboard-section" id="fresherHomeSection">
      <h2>Fresher Dashboard</h2>
      <div class="card">
        <p>Welcome to your job search dashboard!</p>
      </div>
    </div>
    
    <!-- Browse Jobs Section -->
    <div class="dashboard-section" id="fresherJobsSection">
      <h2>Available Jobs</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">← Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Employer</th>
              <th>Location</th>
              <th>Salary</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="availableJobsTable">
            <!-- Available jobs will be listed here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- My Applications Section -->
    <div class="dashboard-section" id="fresherApplicationsSection">
      <h2>My Applications</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">← Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Job Title</th>
              <th>Employer</th>
              <th>Status</th>
              <th>Applied On</th>
            </tr>
          </thead>
          <tbody id="myApplicationsTable">
            <!-- Applications will be listed here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Profile Section -->
    <div class="dashboard-section" id="fresherProfileSection">
      <h2>My Profile</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">← Back to Dashboard</button>
      
      <div class="card">
        <form id="fresherProfileForm">
          <input type="text" id="fullName" placeholder="Full Name" required>
          <input type="text" id="education" placeholder="Education" required>
          <textarea id="skills" placeholder="Skills (comma separated)" required style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px;"></textarea>
          <input type="file" id="resume" accept=".pdf,.doc,.docx">
          <button type="submit" class="success">Update Profile</button>
        </form>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, setDoc, doc, getDoc, collection, where, getDocs, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // Make Firebase functions available globally
  window.query = query;
  window.collection = collection;
  window.where = where;
  window.getDocs = getDocs;
  window.deleteDoc = deleteDoc;

  const firebaseConfig = {
    apiKey: "AIzaSyDrrAYywpFdd9iIzSSp2m6XcrGkGUgYY3Y",
    authDomain: "freshershub-33de8.firebaseapp.com",
    projectId: "freshershub-33de8",
    storageBucket: "freshershub-33de8.appspot.com",
    messagingSenderId: "126389629687",
    appId: "1:126389629687:web:9b9fb43e488f60ac3159f2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // TEMPORARY DEBUG CODE - Add this:
onAuthStateChanged(auth, (user) => {
  console.log("Auth State Changed:", user ? user.email : "No user");
  if (!user) {
    document.getElementById('auth-section').style.display = 'block'; 
  }
});


  // Auth Functions
  window.signup = async function() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      await setDoc(doc(db, "users", user.uid), { 
        email, 
        role,
        createdAt: new Date().toISOString()
      });

      alert("Signup successful!");
      showDashboard(role);
    } catch (err) {
      alert(err.message);
    }
  };

  window.login = async function() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      const docRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const userData = docSnap.data();
        showDashboard(userData.role);
      } else {
        alert("User data not found.");
      }
    } catch (err) {
      alert(err.message);
    }
  };

  window.toggleForm = function() {
    const formTitle = document.getElementById('form-title');
    const actionBtn = document.getElementById('actionBtn');
    const toggleText = document.getElementById('toggle-text');
    const roleSelect = document.getElementById('role');

    if (formTitle.textContent.includes('Signup')) {
    // Switch to login mode
    formTitle.textContent = 'FreshersHub - Login';
    actionBtn.textContent = 'Login';
    actionBtn.onclick = login;
    roleSelect.style.display = 'none';
    toggleText.innerHTML = `Don't have an account? <a id="toggleLink">Signup here</a>`;
  } else {
    // Switch to signup mode
    formTitle.textContent = 'FreshersHub - Signup';
    actionBtn.textContent = 'Signup';
    actionBtn.onclick = signup;
    roleSelect.style.display = 'block';
    toggleText.innerHTML = `Already have an account? <a id="toggleLink">Login here</a>`;
  }

  // ✅ Re-attach the toggle link listener every time
  const toggleLink = document.getElementById('toggleLink');
  if (toggleLink) {
    toggleLink.addEventListener('click', (e) => {
      e.preventDefault();
      toggleForm();
    });
  }
};

  window.showDashboard = function(role) {
    // Hide all dashboards
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('fresherDashboard').style.display = 'none';
    document.getElementById('EmployerDashboard').style.display = 'none';
    
    // Hide all menu buttons
    document.getElementById('adminMenuBtn').style.display = 'none';
    document.getElementById('EmployerMenuBtn').style.display = 'none';
    document.getElementById('fresherMenuBtn').style.display = 'none';
    
    // Hide auth
    document.getElementById('auth-section').style.display = 'none';

    // Show relevant dashboard + menu
    if (role === 'admin') {
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('adminMenuBtn').style.display = 'block';
      showAdminSection('home');
      loadAdminStats();
      loadRecentActivity();
    } else if (role === 'fresher') {
      document.getElementById('fresherDashboard').style.display = 'block';
      document.getElementById('fresherMenuBtn').style.display = 'block';
      showFresherSection('home');
    } else if (role === 'Employer') {
      document.getElementById('EmployerDashboard').style.display = 'block';
      document.getElementById('EmployerMenuBtn').style.display = 'block';
      showEmployerSection('home');
    } else {
      alert("Unknown role: " + role);
    }
  };

  // Menu Toggle Functions
  window.toggleAdminMenu = function() {
    document.getElementById('adminSideMenu').classList.toggle('open');
    document.getElementById('adminOverlay').classList.toggle('show');
  };

  window.toggleEmployerMenu = function() {
    document.getElementById('EmployerSideMenu').classList.toggle('open');
    document.getElementById('EmployerOverlay').classList.toggle('show');
  };

  window.toggleFresherMenu = function() {
    document.getElementById('fresherSideMenu').classList.toggle('open');
    document.getElementById('fresherOverlay').classList.toggle('show');
  };

  // Logout Function
  window.logout = function() {
    signOut(auth).then(() => {
      document.getElementById('auth-section').style.display = 'block';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('EmployerDashboard').style.display = 'none';
      document.getElementById('fresherDashboard').style.display = 'none';
      document.getElementById('adminMenuBtn').style.display = 'none';
      document.getElementById('EmployerMenuBtn').style.display = 'none';
      document.getElementById('fresherMenuBtn').style.display = 'none';
    });
  };

  // Admin Functions
  window.showAdminSection = function(section) {
    // Hide all admin sections
    document.getElementById('adminHomeSection').style.display = 'none';
    document.getElementById('adminUsersSection').style.display = 'none';
    document.getElementById('adminJobsSection').style.display = 'none';
    document.getElementById('adminSettingsSection').style.display = 'none';
    document.getElementById('adminManagementSection').style.display = 'none';
   
    // Show the requested one
    if (section === 'home') {
      document.getElementById('adminHomeSection').style.display = 'block';
    } else if (section === 'users') {
      document.getElementById('adminUsersSection').style.display = 'block';
      loadAllUsers();
    } else if (section === 'jobs') {
      document.getElementById('adminJobsSection').style.display = 'block';
      loadAllJobs();
    } else if (section === 'settings') {
      document.getElementById('adminSettingsSection').style.display = 'block';
    } else if (section === 'management') {
    document.getElementById('adminManagementSection').style.display = 'block';
    loadAdmins(); // We'll create this function next
    }
  };

  window.loadAllUsers = async function() {
    const table = document.getElementById('usersTableBody');
    table.innerHTML = '<tr><td colspan="3">Loading users...</td></tr>';

    try {
      const querySnapshot = await getDocs(collection(db, "users"));
      table.innerHTML = '';

      if (querySnapshot.empty) {
        table.innerHTML = '<tr><td colspan="3">No users found</td></tr>';
        return;
      }

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const row = `
          <tr>
            <td>${data.email}</td>
            <td>${data.role}</td>
            <td>
              <button onclick="deleteUser('${doc.id}')" class="danger">Delete</button>
            </td>
          </tr>`;
        table.innerHTML += row;
      });
    } catch (error) {
      table.innerHTML = '<tr><td colspan="3">Error loading users</td></tr>';
      console.error("Error loading users:", error);
    }
  };

  window.loadAllJobs = async function() {
    const table = document.getElementById('jobsTableBody');
    table.innerHTML = '<tr><td colspan="5">Loading jobs...</td></tr>';

    try {
      const querySnapshot = await getDocs(collection(db, "jobs"));
      table.innerHTML = '';

      if (querySnapshot.empty) {
        table.innerHTML = '<tr><td colspan="5">No jobs found</td></tr>';
        return;
      }

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const row = `
          <tr>
            <td>${data.Title || 'N/A'}</td>
            <td>${data.Employer || 'N/A'}</td>
            <td>${data.location || 'N/A'}</td>
            <td>${data.salary || 'N/A'}</td>
            <td>
              <button onclick="deleteJob('${doc.id}')" class="danger">Delete</button>
            </td>
          </tr>`;
        table.innerHTML += row;
      });
    } catch (error) {
      table.innerHTML = '<tr><td colspan="5">Error loading jobs</td></tr>';
      console.error("Error loading jobs:", error);
    }
  };

  window.deleteUser = async function(userId) {
    if (!confirm("Are you sure you want to delete this user?")) return;
    
    try {
      await deleteDoc(doc(db, "users", userId));
      alert("User deleted successfully");
      loadAllUsers();
    } catch (error) {
      alert("Error deleting user: " + error.message);
    }
  };

  window.deleteJob = async function(jobId) {
    if (!confirm("Are you sure you want to delete this job?")) return;
    
    try {
      await deleteDoc(doc(db, "jobs", jobId));
      alert("Job deleted successfully");
      loadAllJobs();
    } catch (error) {
      alert("Error deleting job: " + error.message);
    }
  };

  // Employer Functions
  window.showEmployerSection = function(section) {
    // Hide all Employer sections
    document.getElementById('EmployerHomeSection').style.display = 'none';
    document.getElementById('EmployerPostJobSection').style.display = 'none';
    document.getElementById('EmployerMyJobsSection').style.display = 'none';

    // Show the requested one
    if (section === 'home') {
      document.getElementById('EmployerHomeSection').style.display = 'block';
    } else if (section === 'postJob') {
      document.getElementById('EmployerPostJobSection').style.display = 'block';
    } else if (section === 'myJobs') {
      document.getElementById('EmployerMyJobsSection').style.display = 'block';
      loadEmployerJobs();
    }
  };

  // Fresher Functions
  window.showFresherSection = function(section) {
    // Hide all fresher sections
    document.getElementById('fresherHomeSection').style.display = 'none';
    document.getElementById('fresherJobsSection').style.display = 'none';
    document.getElementById('fresherApplicationsSection').style.display = 'none';
    document.getElementById('fresherProfileSection').style.display = 'none';

    // Show the requested one
    if (section === 'home') {
      document.getElementById('fresherHomeSection').style.display = 'block';
    } else if (section === 'jobs') {
      document.getElementById('fresherJobsSection').style.display = 'block';
      loadAvailableJobs();
    } else if (section === 'applications') {
      document.getElementById('fresherApplicationsSection').style.display = 'block';
      loadMyApplications();
    } else if (section === 'profile') {
      document.getElementById('fresherProfileSection').style.display = 'block';
      loadFresherProfile();
    }
  };


 // Load admin users list
window.loadAdmins = async function() {
  const table = document.getElementById('adminListTable');
  table.innerHTML = '<tr><td colspan="3">Loading admins...</td></tr>';

  try {
    const currentUser = auth.currentUser;
    const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
    const isOriginalAdmin = currentUserDoc.data().isOriginalAdmin; // You'll need to set this flag for your original admin
    
    const querySnapshot = await getDocs(
      query(collection(db, "users"), 
      where("role", "==", "admin"))
    );
    
    table.innerHTML = '';
    
    if (querySnapshot.empty) {
      table.innerHTML = '<tr><td colspan="3">No admin users found</td></tr>';
      return;
    }
    
    querySnapshot.forEach(doc => {
      const data = doc.data();
      const showRemoveButton = isOriginalAdmin && doc.id !== currentUser.uid; // Don't show remove for self
      
      table.innerHTML += `
        <tr>
          <td>${data.email}</td>
          <td>${new Date(data.createdAt).toLocaleDateString()}</td>
          <td>
            ${showRemoveButton ? `<button onclick="deleteAdmin('${doc.id}')" class="danger">Remove</button>` : ''}
          </td>
        </tr>`;
    });
  } catch (error) {
    table.innerHTML = '<tr><td colspan="3">Error loading admins</td></tr>';
    console.error("Error loading admins:", error);
  }
};

// Create new admin
window.createNewAdmin = async function() {
  const email = document.getElementById('newAdminEmail').value;
  const tempPassword = document.getElementById('newAdminPassword').value;
  
  if (!email || !tempPassword) {
    alert("Please enter both email and password");
    return;
  }
  
  try {
    // 1. Create auth account
    const userCredential = await createUserWithEmailAndPassword(auth, email, tempPassword);
    
    // 2. Set admin role in Firestore
    await setDoc(doc(db, "users", userCredential.user.uid), {
      email: email,
      role: "admin",
      createdAt: new Date().toISOString()
    });
    
    // 3. Force password reset
    await sendPasswordResetEmail(auth, email);
    
    // 4. Refresh admin list
    loadAdmins();
    
    // 5. Clear form
    document.getElementById('newAdminEmail').value = '';
    document.getElementById('newAdminPassword').value = '';
    
    alert(`Admin created successfully! Password reset email sent to ${email}`);
  } catch (error) {
    console.error("Error creating admin:", error);
    alert("Error creating admin: " + error.message);
  }
};

// Delete admin
window.deleteAdmin = async function(userId) {
  // 1. Verify permissions
  const currentUser = auth.currentUser;
  if (!currentUser) return alert("Not authenticated");
  
  const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
  if (!currentUserDoc.data().isOriginalAdmin) {
    return alert("Only original admin can remove admins");
  }

  // 2. Confirmation dialog
  if (!confirm(`Demote ${userId} to regular user?`)) return;

  // 3. Execute demotion
  try {
    await setDoc(doc(db, "users", userId), {
      role: "employer",
      isOriginalAdmin: false 
    }, { merge: true });

    // 4. Log the action
    await addDoc(collection(db, "audit_logs"), {
      action: "admin_demoted",
      target: userId,
      by: currentUser.email,
      timestamp: new Date()
    });

    // 5. Refresh UI
    alert("Admin privileges removed");
    loadAdmins();
  } catch (error) {
    console.error("Demotion failed:", error);
    alert("Error: " + error.message);
  }
};

  // Stats and Activity Functions
  async function loadAdminStats() {
    try {
      // Count Freshers
      const freshersQuery = query(collection(db, "users"), where("role", "==", "fresher"));
      const freshersSnapshot = await getDocs(freshersQuery);
      animateValue("totalFreshers", freshersSnapshot.size);
      document.getElementById('totalFreshers').innerText = freshersSnapshot.size;

      // Count Employers
      const EmployersQuery = query(collection(db, "users"), where("role", "==", "Employer"));
      const EmployersSnapshot = await getDocs(EmployersQuery);
      animateValue("totalEmployers", EmployersSnapshot.size);
      document.getElementById('totalEmployers').innerText = EmployersSnapshot.size;

      // Count Jobs
      const jobsSnapshot = await getDocs(collection(db, "jobs"));
      animateValue("totalJobs", jobsSnapshot.size);
      document.getElementById('totalJobs').innerText = jobsSnapshot.size;
    } catch (error) {
      console.error("Error loading stats:", error);
    }
  }

  async function loadRecentActivity() {
    try {
      // Recent Users
      const usersQuery = query(collection(db, "users"), where("role", "in", ["fresher", "Employer"]));
      const usersSnapshot = await getDocs(usersQuery);
      
      const usersData = [];
      usersSnapshot.forEach(doc => usersData.push({ id: doc.id, ...doc.data() }));
      
      // Sort by creation date (newest first)
      usersData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      const last5Users = usersData.slice(0, 5);
      
      const usersTable = document.getElementById('recentUsersTable');
      usersTable.innerHTML = "";
      last5Users.forEach(user => {
        usersTable.innerHTML += `<tr><td>${user.email}</td><td>${user.role}</td></tr>`;
      });

      // Recent Jobs
      const jobsSnapshot = await getDocs(collection(db, "jobs"));
      const jobsData = [];
      jobsSnapshot.forEach(doc => jobsData.push({ id: doc.id, ...doc.data() }));
      
      // Sort by creation date (newest first)
      jobsData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      const last5Jobs = jobsData.slice(0, 5);
      
      const jobsTable = document.getElementById('recentJobsTable');
      jobsTable.innerHTML = "";
      last5Jobs.forEach(job => {
        jobsTable.innerHTML += `
          <tr>
            <td>${job.Title || 'N/A'}</td>
            <td>${job.Employer || 'N/A'}</td>
            <td>${job.location || 'N/A'}</td>
          </tr>`;
      });
    } catch (error) {
      console.error("Error loading recent activity:", error);
    }
  }

  // Initialize Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Toggle between login/signup
    const toggleLink = document.getElementById('toggleLink');
    toggleLink.addEventListener('click', (e) => {
      e.preventDefault();
      toggleForm();
    });

    // Admin menu links
    document.getElementById('adminMenuHome').addEventListener('click', (e) => {
      e.preventDefault();
      showAdminSection('home');
      toggleAdminMenu();
    });
    
    document.getElementById('adminMenuUsers').addEventListener('click', (e) => {
      e.preventDefault();
      showAdminSection('users');
      toggleAdminMenu();
    });
    
    document.getElementById('adminMenuJobs').addEventListener('click', (e) => {
      e.preventDefault();
      showAdminSection('jobs');
      toggleAdminMenu();
    });
    
    document.getElementById('adminMenuSettings').addEventListener('click', (e) => {
      e.preventDefault();
      showAdminSection('settings');
      toggleAdminMenu();
    });

    // Employer menu links
    document.getElementById('EmployerMenuHome').addEventListener('click', (e) => {
      e.preventDefault();
      showEmployerSection('home');
      toggleEmployerMenu();
    });
    
    document.getElementById('EmployerMenuPostJob').addEventListener('click', (e) => {
      e.preventDefault();
      showEmployerSection('postJob');
      toggleEmployerMenu();
    });
    
    document.getElementById('EmployerMenuMyJobs').addEventListener('click', (e) => {
      e.preventDefault();
      showEmployerSection('myJobs');
      toggleEmployerMenu();
    });

    // Fresher menu links
    document.getElementById('fresherMenuHome').addEventListener('click', (e) => {
      e.preventDefault();
      showFresherSection('home');
      toggleFresherMenu();
    });
    
    document.getElementById('fresherMenuJobs').addEventListener('click', (e) => {
      e.preventDefault();
      showFresherSection('jobs');
      toggleFresherMenu();
    });
    
    document.getElementById('fresherMenuApplications').addEventListener('click', (e) => {
      e.preventDefault();
      showFresherSection('applications');
      toggleFresherMenu();
    });
    
    document.getElementById('fresherMenuProfile').addEventListener('click', (e) => {
      e.preventDefault();
      showFresherSection('profile');
      toggleFresherMenu();
    });

    // Post Job Form
    const postJobForm = document.getElementById('postJobForm');
    if (postJobForm) {
      postJobForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('jobTitle').value;
        const description = document.getElementById('jobDescription').value;
        const location = document.getElementById('jobLocation').value;
        const salary = document.getElementById('jobSalary').value;
        
        try {
          const user = auth.currentUser;
          if (!user) throw new Error("Not authenticated");
          
          await addDoc(collection(db, "jobs"), {
            Title: title,
            description: description,
            location: location,
            salary: salary,
            Employer: user.email,
            createdAt: new Date().toISOString()
          });
          
          alert("Job posted successfully!");
          postJobForm.reset();
        } catch (error) {
          alert("Error posting job: " + error.message);
        }
      });
    }

    // Check auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists()) {
          showDashboard(snap.data().role);
        }
      }
    });
  });

  // Placeholder functions for future implementation
  window.loadEmployerJobs = function() {
    document.getElementById('EmployerJobsTable').innerHTML = `
      <tr>
        <td colspan="4">Job listings will appear here</td>
      </tr>`;
  };

  window.loadAvailableJobs = function() {
    document.getElementById('availableJobsTable').innerHTML = `
      <tr>
        <td colspan="5">Available jobs will appear here</td>
      </tr>`;
  };

  window.loadMyApplications = function() {
    document.getElementById('myApplicationsTable').innerHTML = `
      <tr>
        <td colspan="4">Your applications will appear here</td>
      </tr>`;
  };

  window.loadFresherProfile = function() {
    // Would load profile data here
  };

  // Number counting animation
function animateValue(element, target, duration = 1000) {
  const start = 0;
  const increment = target / (duration / 16); // 60fps
  let current = start;
  const el = document.getElementById(element);
  
  const timer = setInterval(() => {
    current += increment;
    if (current >= target) {
      clearInterval(timer);
      current = target;
    }
    el.textContent = Math.floor(current);
  }, 16);
}


// ===== PASTE THIS RIGHT BEFORE THE CLOSING </script> TAG =====
// Audit Logging System
async function logAdminAction(action, target) {
  try {
    const user = auth.currentUser;
    if (!user) return;
    
    const userDoc = await getDoc(doc(db, "users", user.uid));
    
    await addDoc(collection(db, "audit_logs"), {
      adminEmail: user.email,
      adminId: user.uid,
      isOriginalAdmin: userDoc.data().isOriginalAdmin || false,
      action: action,
      target: target,
      timestamp: new Date(),
      ipAddress: await fetch('https://api.ipify.org?format=json')
        .then(r => r.json())
        .then(data => data.ip)
        .catch(() => 'unknown')
    });
  } catch (error) {
    console.error("Failed to log action:", error);
  }
}

// Initialize audit log for critical actions
window.deleteUser = async function(userId) {
  if (!confirm("Are you sure?")) return;
  
  try {
    await deleteDoc(doc(db, "users", userId));
    await logAdminAction("user_deleted", userId);
    alert("User deleted");
    loadAllUsers();
  } catch (error) {
    alert("Error: " + error.message);
  }
};

window.deleteJob = async function(jobId) {
  if (!confirm("Are you sure?")) return;
  
  try {
    await deleteDoc(doc(db, "jobs", jobId));
    await logAdminAction("job_deleted", jobId);
    alert("Job deleted");
    loadAllJobs();
  } catch (error) {
    alert("Error: " + error.message);
  }
};

</script>
</body>
</html>
