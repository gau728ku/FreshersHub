<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- 
    =============================================
    HTML HEAD SECTION - METADATA AND STYLES
    =============================================
    Contains page metadata, title, and CSS styles
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FreshersHub - Job Portal</title>
  
  <style>
    /* 
      =============================================
      CSS STYLES SECTION
      =============================================
      All visual styling for the application
    */
    
    /* Base styles */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom right, rgba(0, 114, 255, 0.6), rgba(0, 198, 255, 0.6)),
        url('https://images.unsplash.com/photo-1519389950473-47ba0277781c?fit=crop&w=1650&q=80') no-repeat center center;
      background-size: cover;
      background-attachment: fixed;
      color: white;
    }

    /* Login/Signup container */
    .container {
      max-width: 400px;
      margin: 5% auto;
      padding: 2rem;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }

    /* Form elements */
    h2 { text-align: center; margin-bottom: 1.5rem; }
    input, select, button {
      width: 100%; padding: 12px; margin: 8px 0;
      border: none; border-radius: 8px; font-size: 1rem;
    }

    /* Button styles */
    button { 
      background-color: #00c6ff; 
      color: white; 
      cursor: pointer; 
      transition: background 0.3s;
    }
    button:hover { background-color: #1c78e9; }
    button.danger { background-color: #dc3545; }
    button.danger:hover { background-color: #c82333; }
    button.success { background-color: #28a745; }
    button.success:hover { background-color: #218838; }

    /* Dashboard components */
    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      backdrop-filter: blur(5px);
    }

    /* Table styles */
    .table-container {
      overflow-x: auto;
      margin: 20px 0;
      background: white;
      border-radius: 10px;
      color: black;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }

    /* Navigation menu styles */
    #adminMenuBtn, #fresherMenuBtn, #EmployerMenuBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 28px;
      cursor: pointer;
      z-index: 1001;
      display: none;
      color: white;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      text-align: center;
      line-height: 40px;
    }

    /* Side menu styles */
    .sideMenu {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background: rgba(0,0,0,0.9);
      color: white;
      padding-top: 60px;
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    
    .sideMenu.open { transform: translateX(250px); }
    
    .sideMenu a {
      display: block;
      color: white;
      padding: 12px 20px;
      text-decoration: none;
      font-size: 18px;
      border-left: 4px solid transparent;
    }
    
    .sideMenu a:hover {
      background: rgba(255,255,255,0.1);
      border-left: 4px solid #00c6ff;
    }

    /* Overlay styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      display: none;
    }
    
    .overlay.show { display: block; }

    /* Link styles */
    #toggle-text a {
      color: #00aeff; 
      font-weight: bold;
      text-decoration: underline;
      cursor: pointer;
    }

    /* Dashboard sections */
    .dashboard-section {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Stats container */
    .stats-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    
    /* Horizontal stats variation */
    .stats-container.horizontal {
       flex-wrap: nowrap;
       overflow-x: auto;
       padding-bottom: 10px;
    }

    /* Stat card styles */
    .stat-card {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      width: 200px;
      text-align: center;
      backdrop-filter: blur(5px);
    }
    
    .stat-card h3 {
      margin-top: 10px;
      font-size: 2rem;
      transition: transform 0.3s ease;
    }

    .stat-card:hover h3 {
      transform: scale(1.1);
      color: #00c6ff;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .stats-container {
        flex-direction: row;
        justify-content: flex-start;
      }
      .stat-card {
        min-width: 180px;
      }
    }
  </style>
</head>
<body>

  <!-- 
    =============================================
    AUTHENTICATION SECTION (LOGIN/SIGNUP)
    =============================================
    Handles user authentication with role selection
  -->
  <div class="container" id="auth-section">
    <h2 id="form-title">FreshersHub - Signup</h2>
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <select id="role">
      <option value="fresher">Fresher</option>
      <option value="Employer">Employer</option>
    </select>
    <button id="actionBtn" onclick="signup()">Signup</button>
    <p id="toggle-text">Already have an account? <a id="toggleLink">Login here</a></p>
  </div>

  <!-- 
    =============================================
    ADMIN DASHBOARD SECTION
    =============================================
    Contains all admin-specific functionality including:
    - User management
    - Job management
    - System settings
  -->
  <div id="adminDashboard" style="display:none;">
    <!-- Admin menu button -->
    <div id="adminMenuBtn" onclick="toggleAdminMenu()">‚ò∞</div>

    <!-- Admin side menu -->
    <div class="sideMenu" id="adminSideMenu">
      <a href="#" id="adminMenuHome">Dashboard</a>
      <a href="#" id="adminMenuUsers">Manage Users</a>
      <a href="#" id="adminMenuJobs">Manage Jobs</a>
      <a href="#" id="adminMenuSettings">Settings</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>

    <div class="overlay" id="adminOverlay" onclick="toggleAdminMenu()"></div>

    <!-- Admin Home Section -->
    <div class="dashboard-section" id="adminHomeSection">
      <h2>Admin Dashboard</h2>
      
      <div class="stats-container horizontal">
        <div class="stat-card">
          <p>Total Freshers</p>
          <h3 id="totalFreshers">-</h3>
        </div>
        <div class="stat-card">
          <p>Total Employers</p>
          <h3 id="totalEmployers">-</h3>
        </div>
        <div class="stat-card">
          <p>Total Jobs</p>
          <h3 id="totalJobs">-</h3>
        </div>
      </div>

      <div class="card">
        <h3 style="text-align: center;">Recent Activity</h3>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
          <!-- Recent Users Table -->
          <div style="flex: 1; min-width: 300px;">
            <h4>Last 5 Users</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr><th>Email</th><th>Role</th></tr>
                </thead>
                <tbody id="recentUsersTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Recent Jobs Table -->
          <div style="flex: 1; min-width: 300px;">
            <h4>Last 5 Jobs</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Employer</th>
                    <th>Location</th>
                  </tr>
                </thead>
                <tbody id="recentJobsTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Manage Users Section -->
    <div class="dashboard-section" id="adminUsersSection">
      <h2>Manage Users</h2>
      <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- User data will be dynamically inserted here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Manage Jobs Section -->
    <div class="dashboard-section" id="adminJobsSection">
      <h2>Manage Job Listings</h2>
      <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Employer</th>
              <th>Location</th>
              <th>Salary</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="jobsTableBody">
            <!-- Job data will be dynamically inserted here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Settings Section -->
    <div class="dashboard-section" id="adminSettingsSection">
      <h2>Admin Settings</h2>
      <button onclick="showAdminSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="card">
        <h3>System Configuration</h3>
        <h2>Admin Management</h2>
<div id="adminSection">
  <h3>Current Admins</h3>
  <table id="adminTable">
    <thead>
      <tr><th>Email</th><th>Action</th></tr>
    </thead>
    <tbody id="adminTableBody"></tbody>
  </table>

<div id="addAdminSection" style="display: none;">
  <h3>Promote User to Admin</h3>
  <input type="email" id="promoteEmail" placeholder="Enter user email">
  <button onclick="promoteToAdmin()">Promote</button>
    </div>
    </div>
    </div>
  </div>

  <!-- 
    =============================================
    EMPLOYER DASHBOARD SECTION
    =============================================
    Contains employer-specific functionality including:
    - Job posting
    - Job management
  -->
  <div id="EmployerDashboard" style="display:none;">
    <div id="EmployerMenuBtn" onclick="toggleEmployerMenu()">‚ò∞</div>
    
    <div class="sideMenu" id="EmployerSideMenu">
      <a href="#" id="EmployerMenuHome">Dashboard</a>
      <a href="#" id="EmployerMenuPostJob">Post Job</a>
      <a href="#" id="EmployerMenuMyJobs">My Jobs</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
    
    <div class="overlay" id="EmployerOverlay" onclick="toggleEmployerMenu()"></div>
    
    <!-- Employer Home Section -->
    <div class="dashboard-section" id="EmployerHomeSection">
      <h2>Employer Dashboard</h2>
      <div class="card">
        <p>Welcome to your Employer dashboard!</p>
      </div>
    </div>
    
    <!-- Post Job Section -->
    <div class="dashboard-section" id="EmployerPostJobSection">
      <h2>Post New Job</h2>
      <button onclick="showEmployerSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="card">
        <form id="postJobForm">
          <input type="text" id="jobTitle" placeholder="Job Title" required>
          <textarea id="jobDescription" placeholder="Job Description" required style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px;"></textarea>
          <input type="text" id="jobLocation" placeholder="Location" required>
          <input type="text" id="jobSalary" placeholder="Salary Range" required>
          <button type="submit" class="success">Post Job</button>
        </form>
      </div>
    </div>
    
    <!-- My Jobs Section -->
    <div class="dashboard-section" id="EmployerMyJobsSection">
      <h2>My Job Postings</h2>
      <button onclick="showEmployerSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Applications</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="EmployerJobsTable">
            <!-- Employer's jobs will be listed here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 
    =============================================
    FRESHER DASHBOARD SECTION
    =============================================
    Contains fresher-specific functionality including:
    - Job browsing
    - Applications management
    - Profile management
  -->
  <div id="fresherDashboard" style="display:none;">
    <div id="fresherMenuBtn" onclick="toggleFresherMenu()">‚ò∞</div>
    
    <div class="sideMenu" id="fresherSideMenu">
      <a href="#" id="fresherMenuHome">Dashboard</a>
      <a href="#" id="fresherMenuJobs">Browse Jobs</a>
      <a href="#" id="fresherMenuApplications">My Applications</a>
      <a href="#" id="fresherMenuProfile">Profile</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
    
    <div class="overlay" id="fresherOverlay" onclick="toggleFresherMenu()"></div>
    
    <!-- Fresher Home Section -->
    <div class="dashboard-section" id="fresherHomeSection">
      <h2>Fresher Dashboard</h2>
      <div class="card">
        <p>Welcome to your job search dashboard!</p>
      </div>
    </div>
    
    <!-- Browse Jobs Section -->
    <div class="dashboard-section" id="fresherJobsSection">
      <h2>Available Jobs</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Employer</th>
              <th>Location</th>
              <th>Salary</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="availableJobsTable">
            <!-- Available jobs will be listed here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- My Applications Section -->
    <div class="dashboard-section" id="fresherApplicationsSection">
      <h2>My Applications</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Job Title</th>
              <th>Employer</th>
              <th>Status</th>
              <th>Applied On</th>
            </tr>
          </thead>
          <tbody id="myApplicationsTable">
            <!-- Applications will be listed here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Profile Section -->
    <div class="dashboard-section" id="fresherProfileSection">
      <h2>My Profile</h2>
      <button onclick="showFresherSection('home')" style="margin-bottom: 20px;">‚Üê Back to Dashboard</button>
      
      <div class="card">
        <form id="fresherProfileForm">
          <input type="text" id="fullName" placeholder="Full Name" required>
          <input type="text" id="education" placeholder="Education" required>
          <textarea id="skills" placeholder="Skills (comma separated)" required style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px;"></textarea>
          <input type="file" id="resume" accept=".pdf,.doc,.docx">
          <button type="submit" class="success">Update Profile</button>
        </form>
      </div>
    </div>
  </div>

<script type="module">
  
  // ‚úÖ Global scope variable to track current role
let currentUserRole = null;
  
  /*
    =============================================
    JAVASCRIPT MODULE - APPLICATION LOGIC
    =============================================
    Contains all the application functionality including:
    - Firebase initialization
    - Authentication
    - Data management
    - UI interactions
  */

  // Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, setDoc, doc, getDoc, collection, where, getDocs, query, addDoc, deleteDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Make Firebase functions available globally
  window.query = query;
  window.collection = collection;
  window.where = where;
  window.getDocs = getDocs;
  window.deleteDoc = deleteDoc;

  /*
    =============================================
    FIREBASE CONFIGURATION
    =============================================
    Configuration object for Firebase services
  */
  const firebaseConfig = {
    apiKey: "AIzaSyDrrAYywpFdd9iIzSSp2m6XcrGkGUgYY3Y",
    authDomain: "freshershub-33de8.firebaseapp.com",
    projectId: "freshershub-33de8",
    storageBucket: "freshershub-33de8.appspot.com",
    messagingSenderId: "126389629687",
    appId: "1:126389629687:web:9b9fb43e488f60ac3159f2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /*
    =============================================
    AUTHENTICATION FUNCTIONS
    =============================================
    Handles user signup, login, and role management
  */

  /**
   * Handles user signup with email/password and role selection
   * Creates user in Firebase Auth and stores additional data in Firestore
   */
  window.signup = async function() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const role = document.getElementById('role').value;

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    await setDoc(doc(db, "users", user.uid), { 
      email, 
      role,
      createdAt: new Date().toISOString(),
      isOriginalAdmin: email === "gauravku7409@gmail.com" // ‚úÖ Only true for you
    });

    alert("Signup successful!");
    showDashboard(role);
  } catch (err) {
    alert(err.message);
  }
};

  /**
   * Handles user login with email/password
   * Retrieves user role from Firestore and shows appropriate dashboard
   */


let unsubscribeRoleListener = null;

window.login = async function () {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    const docRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      const userData = docSnap.data();
      const initialRole = userData.role;

      showDashboard(initialRole); // ‚úÖ Show dashboard based on current role

      // üëÄ Listen for role change
      onSnapshot(docRef, (snapshot) => {
        const newRole = snapshot.data()?.role;
         console.log("Role changed:", newRole);
        if (newRole !== initialRole) {
          alert("Your role has changed. You'll be logged out.");
          signOut(auth).then(() => {
            window.location.href = "/index.html"; // redirect to login
          });
        }
      });

    } else {
      alert("User data not found.");
    }

  } catch (err) {
    console.error("Login error:", err);
    alert(err.message);
  }
};



  /**
   * Toggles between login and signup forms
   * Adjusts form fields and button actions accordingly
   */
  window.toggleForm = function() {
    const formTitle = document.getElementById('form-title');
    const actionBtn = document.getElementById('actionBtn');
    const toggleText = document.getElementById('toggle-text');
    const roleSelect = document.getElementById('role');

    if (formTitle.textContent.includes('Signup')) {
      // Switch to login mode
      formTitle.textContent = 'FreshersHub - Login';
      actionBtn.textContent = 'Login';
      actionBtn.onclick = login;
      toggleText.innerHTML = `Don't have an account? <a id="toggleLink">Signup here</a>`;
      roleSelect.style.display = 'none';
    } else {
      // Switch to signup mode
      formTitle.textContent = 'FreshersHub - Signup';
      actionBtn.textContent = 'Signup';
      actionBtn.onclick = signup;
      toggleText.innerHTML = `Already have an account? <a id="toggleLink">Login here</a>`;
      roleSelect.style.display = 'block';
    } 
      // Re-attach the toggle link listener every time
      const toggleLink = document.getElementById('toggleLink');
    if (toggleLink) {
      toggleLink.addEventListener('click', (e) => {
      e.preventDefault();
      toggleForm();
    });
    }
  };

  /*
    =============================================
    DASHBOARD MANAGEMENT FUNCTIONS
    =============================================
    Controls dashboard visibility and navigation
  */

  /**
   * Shows the appropriate dashboard based on user role
   * @param {string} role - User role (admin, fresher, or Employer)
   */
  window.showDashboard = function(role) {
    // Hide all dashboards
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('fresherDashboard').style.display = 'none';
    document.getElementById('EmployerDashboard').style.display = 'none';
    
    // Hide all menu buttons
    document.getElementById('adminMenuBtn').style.display = 'none';
    document.getElementById('EmployerMenuBtn').style.display = 'none';
    document.getElementById('fresherMenuBtn').style.display = 'none';
    
    // Hide auth section
    document.getElementById('auth-section').style.display = 'none';

    // Show relevant dashboard + menu
    if (role === 'admin') {
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('adminMenuBtn').style.display = 'block';
      showAdminSection('home');
      loadAdminStats();
      loadRecentActivity();
    } else if (role === 'fresher') {
      document.getElementById('fresherDashboard').style.display = 'block';
      document.getElementById('fresherMenuBtn').style.display = 'block';
      showFresherSection('home');
    } else if (role === 'Employer') {
      document.getElementById('EmployerDashboard').style.display = 'block';
      document.getElementById('EmployerMenuBtn').style.display = 'block';
      showEmployerSection('home');
    } else {
      alert("Unknown role: " + role);
    }
  };

  /*
    =============================================
    MENU TOGGLE FUNCTIONS
    =============================================
    Handles side menu visibility for different user roles
  */

  /** Toggles admin side menu visibility */
  window.toggleAdminMenu = function() {
    document.getElementById('adminSideMenu').classList.toggle('open');
    document.getElementById('adminOverlay').classList.toggle('show');
  };

  /** Toggles employer side menu visibility */
  window.toggleEmployerMenu = function() {
    document.getElementById('EmployerSideMenu').classList.toggle('open');
    document.getElementById('EmployerOverlay').classList.toggle('show');
  };

  /** Toggles fresher side menu visibility */
  window.toggleFresherMenu = function() {
    document.getElementById('fresherSideMenu').classList.toggle('open');
    document.getElementById('fresherOverlay').classList.toggle('show');
  };

  /*
    =============================================
    USER MANAGEMENT FUNCTIONS
    =============================================
    Handles logout and session management
  */

  /** Logs out the current user and returns to auth screen */
  window.logout = function() {
    signOut(auth).then(() => {
      document.getElementById('auth-section').style.display = 'block';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('EmployerDashboard').style.display = 'none';
      document.getElementById('fresherDashboard').style.display = 'none';
      document.getElementById('adminMenuBtn').style.display = 'none';
      document.getElementById('EmployerMenuBtn').style.display = 'none';
      document.getElementById('fresherMenuBtn').style.display = 'none';
    });
  };

  /*
    =============================================
    ADMIN DASHBOARD FUNCTIONS
    =============================================
    Specific functionality for admin dashboard sections
  */

  /**
   * Shows the specified admin dashboard section
   * @param {string} section - Section to show (home, users, jobs, settings)
   */
  window.showAdminSection = function(section) {
    // Hide all admin sections
    document.getElementById('adminHomeSection').style.display = 'none';
    document.getElementById('adminUsersSection').style.display = 'none';
    document.getElementById('adminJobsSection').style.display = 'none';
    document.getElementById('adminSettingsSection').style.display = 'none';

    // Show the requested section
    if (section === 'home') {
      document.getElementById('adminHomeSection').style.display = 'block';
    } else if (section === 'users') {
      document.getElementById('adminUsersSection').style.display = 'block';
      loadAllUsers();
    } else if (section === 'jobs') {
      document.getElementById('adminJobsSection').style.display = 'block';
      loadAllJobs();
    } else if (section === 'settings') {
      document.getElementById('adminSettingsSection').style.display = 'block';
    }
  };

  /**
   * Loads all users from Firestore and displays them in a table
   */
  window.loadAllUsers = async function() {
  const table = document.getElementById('usersTableBody');
  table.innerHTML = '<tr><td colspan="3">Loading users...</td></tr>';

  try {
    const querySnapshot = await getDocs(collection(db, "users"));
    table.innerHTML = '';

    if (querySnapshot.empty) {
      table.innerHTML = '<tr><td colspan="3">No users found</td></tr>';
      return;
    }

    querySnapshot.forEach(doc => {
      const data = doc.data();
      const isOriginalAdmin = data.isOriginalAdmin;
      
      // Show the delete button only if the user is not the original admin
      const deleteButton = isOriginalAdmin ? '' : `<button onclick="deleteUser('${doc.id}')" class="danger">Delete</button>`;

      const row = `
        <tr>
          <td>${data.email}</td>
          <td>${data.role}</td>
          <td>
            ${deleteButton}
          </td>
        </tr>`;
      table.innerHTML += row;
    });
  } catch (error) {
    table.innerHTML = '<tr><td colspan="3">Error loading users</td></tr>';
    console.error("Error loading users:", error);
  }
};



  /**
   * Loads all jobs from Firestore and displays them in a table
   */
  window.loadAllJobs = async function() {
    const table = document.getElementById('jobsTableBody');
    table.innerHTML = '<tr><td colspan="5">Loading jobs...</td></tr>';

    try {
      const querySnapshot = await getDocs(collection(db, "jobs"));
      table.innerHTML = '';

      if (querySnapshot.empty) {
        table.innerHTML = '<tr><td colspan="5">No jobs found</td></tr>';
        return;
      }

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const row = `
          <tr>
            <td>${data.Title || 'N/A'}</td>
            <td>${data.Employer || 'N/A'}</td>
            <td>${data.location || 'N/A'}</td>
            <td>${data.salary || 'N/A'}</td>
            <td>
              <button onclick="deleteJob('${doc.id}')" class="danger">Delete</button>
            </td>
          </tr>`;
        table.innerHTML += row;
      });
    } catch (error) {
      table.innerHTML = '<tr><td colspan="5">Error loading jobs</td></tr>';
      console.error("Error loading jobs:", error);
    }
  };

  /**
   * Deletes a user from Firestore
   * @param {string} userId - ID of the user to delete
   */
  window.deleteUser = async function(userId) {
    if (!confirm("Are you sure you want to delete this user?")) return;
    
    try {
      await deleteDoc(doc(db, "users", userId));
      alert("User deleted successfully");
      loadAllUsers();
    } catch (error) {
      alert("Error deleting user: " + error.message);
    }
  };

  /**
   * Deletes a job from Firestore
   * @param {string} jobId - ID of the job to delete
   */
  window.deleteJob = async function(jobId) {
    if (!confirm("Are you sure you want to delete this job?")) return;
    
    try {
      await deleteDoc(doc(db, "jobs", jobId));
      alert("Job deleted successfully");
      loadAllJobs();
    } catch (error) {
      alert("Error deleting job: " + error.message);
    }
  };

  // promote to Admin function
   
  window.promoteToAdmin = async function () {
  const email = document.getElementById('promoteEmail').value.trim();

  if (!email) {
    alert("Enter a valid email.");
    return;
  }

  try {
    const snapshot = await getDocs(query(collection(db, "users"), where("email", "==", email)));

    if (snapshot.empty) {
      alert("User not found.");
      return;
    }

    const userDoc = snapshot.docs[0];
    await updateDoc(userDoc.ref, { role: "admin" });

    alert("User promoted to admin!");

    document.getElementById("promoteEmail").value = "";

    // ‚úÖ This reloads the admins list and shows the Revoke button
    await loadAdminManagement();

  } catch (err) {
    alert("Error promoting admin: " + err.message);
  }
};


// Load Admin List function

window.loadAdmins = async function (isOriginalAdmin = false) {
  const table = document.getElementById('adminTableBody');
  table.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';

  try {
    const currentUser = auth.currentUser;
    const snapshot = await getDocs(collection(db, "users"));
    table.innerHTML = '';

    snapshot.forEach(docSnap => {
      const data = docSnap.data();

      if (data.role === "admin") {
        const isTargetOriginalAdmin = data.isOriginalAdmin === true;
        const isSelf = docSnap.id === currentUser.uid;

        // ‚úÖ Only original admin can revoke others (not self or original admins)
        let actionCell = "-";
        if (isOriginalAdmin && !isTargetOriginalAdmin && !isSelf) {
          actionCell = `<button onclick="revokeAdmin('${docSnap.id}')">Revoke</button>`;
        }

        table.innerHTML += `
          <tr>
            <td>${data.email}</td>
            <td>${actionCell}</td>
          </tr>`;
      }
    });

    if (table.innerHTML === '') {
      table.innerHTML = '<tr><td colspan="2">No admins found</td></tr>';
    }

  } catch (err) {
    console.error("Error loading admins:", err);
    table.innerHTML = '<tr><td colspan="2">Error loading admins</td></tr>';
  }
};



//revoke Admin function

window.revokeAdmin = async function(userId) {
  if (!confirm("Are you sure you want to revoke admin rights?")) return;

  try {
    await updateDoc(doc(db, "users", userId), {
      role: "fresher" // or whatever default you prefer
    });
    alert("Admin rights revoked");
    loadAdmins();
  } catch (err) {
    console.error(err);
    alert("Error revoking admin rights");
  }
};

//loaddashboard

window.loadDashboard = async function() {
  const user = auth.currentUser; // Get the current logged-in user
  const docRef = doc(db, "users", user.uid);
  const docSnap = await getDoc(docRef);

  if (docSnap.exists()) {
    const userData = docSnap.data();
    const role = userData.role;
    const isOriginalAdmin = userData.isOriginalAdmin;

    // Show specific sections based on role
    if (isOriginalAdmin) {
      // Show all admin options for the original admin
      document.getElementById("adminSettings").style.display = "block"; // For the original admin
      document.getElementById("manageUsers").style.display = "block";   // Manage users
      document.getElementById("manageJobs").style.display = "block";    // Manage jobs
    } else if (role === "admin") {
      // Show promoted admin options, but hide top-level admin settings
      document.getElementById("adminSettings").style.display = "none"; // Hide settings
      document.getElementById("manageUsers").style.display = "block";  // Manage users
      document.getElementById("manageJobs").style.display = "block";   // Manage jobs
    } else {
      // Hide everything for regular users (fresher/employer)
      document.getElementById("adminSettings").style.display = "none";
      document.getElementById("manageUsers").style.display = "none";
      document.getElementById("manageJobs").style.display = "none";
    }
  }
};

//load stats and recent activity
window.loadStatsAndRecentActivity = async function() {
  const user = auth.currentUser;
  const docRef = doc(db, "users", user.uid);
  const docSnap = await getDoc(docRef);

  if (docSnap.exists()) {
    const userData = docSnap.data();
    const isOriginalAdmin = userData.isOriginalAdmin;
    const isPromotedAdmin = userData.role === "admin" && !isOriginalAdmin;

    if (isOriginalAdmin || isPromotedAdmin) {
      // Load stats
      try {
        const statsSnap = await getDocs(collection(db, "stats"));
        // Process stats data here
        console.log("Stats:", statsSnap.docs);
      } catch (error) {
        console.error("Error loading stats:", error);
      }

      // Load recent activity
      try {
        const activitySnap = await getDocs(collection(db, "recentActivity"));
        // Process recent activity data here
        console.log("Recent Activity:", activitySnap.docs);
      } catch (error) {
        console.error("Error loading recent activity:", error);
      }
    } else {
      console.log("You do not have permission to view stats and activity.");
    }
  }
};

//loadadmin settings()

window.loadAdminSettings = async function() {
  const userRef = doc(db, "users", auth.currentUser.uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    const currentUser = userSnap.data();

    // Show Add Admin form only if original admin
    if (currentUser.isOriginalAdmin === true) {
      document.getElementById("addAdminSection").style.display = "block";
    } else {
      document.getElementById("addAdminSection").style.display = "none";
    }

    // Load current admins into the table
    const querySnapshot = await getDocs(collection(db, "users"));
    const tableBody = document.getElementById("adminTableBody");
    tableBody.innerHTML = "";

    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (data.role === "admin") {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.email}</td>
          <td>${data.role}</td>
          <td>
            ${currentUser.isOriginalAdmin === true && data.isOriginalAdmin !== true
              ? `<button onclick="removeAdmin('${docSnap.id}')">Remove</button>`
              : ""}
          </td>`;
        tableBody.appendChild(row);
      }
    });
  }
};

//loadadminmanagement

window.loadAdminManagement = async function () {
  const currentUser = auth.currentUser;
  const addAdminForm = document.getElementById('addAdminSection');

  if (!currentUser) return;

  try {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    const userData = userDoc.data();
    const isOriginalAdmin = userData?.isOriginalAdmin === true;

   
  // ‚úÖ Show/hide Add Admin section
  addAdminForm.style.display = isOriginalAdmin ? "block" : "none";

  // ‚úÖ Load current admins table with revoke buttons if original admin
  loadAdmins(isOriginalAdmin);

} catch (err) {
  console.error("Error loading admin settings:", err);
}
};





  /*
    =============================================
    EMPLOYER DASHBOARD FUNCTIONS
    =============================================
    Specific functionality for employer dashboard sections
  */

  /**
   * Shows the specified employer dashboard section
   * @param {string} section - Section to show (home, postJob, myJobs)
   */
  window.showEmployerSection = function(section) {
    // Hide all Employer sections
    document.getElementById('EmployerHomeSection').style.display = 'none';
    document.getElementById('EmployerPostJobSection').style.display = 'none';
    document.getElementById('EmployerMyJobsSection').style.display = 'none';

    // Show the requested section
    if (section === 'home') {
      document.getElementById('EmployerHomeSection').style.display = 'block';
    } else if (section === 'postJob') {
      document.getElementById('EmployerPostJobSection').style.display = 'block';
    } else if (section === 'myJobs') {
      document.getElementById('EmployerMyJobsSection').style.display = 'block';
      loadEmployerJobs();
    }
  };

  /*
    =============================================
    FRESHER DASHBOARD FUNCTIONS
    =============================================
    Specific functionality for fresher dashboard sections
  */

  /**
   * Shows the specified fresher dashboard section
   * @param {string} section - Section to show (home, jobs, applications, profile)
   */
  window.showFresherSection = function(section) {
    // Hide all fresher sections
    document.getElementById('fresherHomeSection').style.display = 'none';
    document.getElementById('fresherJobsSection').style.display = 'none';
    document.getElementById('fresherApplicationsSection').style.display = 'none';
    document.getElementById('fresherProfileSection').style.display = 'none';

    // Show the requested section
    if (section === 'home') {
      document.getElementById('fresherHomeSection').style.display = 'block';
    } else if (section === 'jobs') {
      document.getElementById('fresherJobsSection').style.display = 'block';
      loadAvailableJobs();
    } else if (section === 'applications') {
      document.getElementById('fresherApplicationsSection').style.display = 'block';
      loadMyApplications();
    } else if (section === 'profile') {
      document.getElementById('fresherProfileSection').style.display = 'block';
      loadFresherProfile();
    }
  };

  /*
    =============================================
    STATS AND ACTIVITY FUNCTIONS
    =============================================
    Handles dashboard statistics and recent activity
  */

  /**
   * Loads admin dashboard statistics (freshers, employers, jobs counts)
   */
  async function loadAdminStats() {
    try {
      // Count Freshers
      const freshersQuery = query(collection(db, "users"), where("role", "==", "fresher"));
      const freshersSnapshot = await getDocs(freshersQuery);
      animateValue("totalFreshers", freshersSnapshot.size);
      document.getElementById('totalFreshers').innerText = freshersSnapshot.size;

      // Count Employers
      const EmployersQuery = query(collection(db, "users"), where("role", "==", "Employer"));
      const EmployersSnapshot = await getDocs(EmployersQuery);
      animateValue("totalEmployers", EmployersSnapshot.size);
      document.getElementById('totalEmployers').innerText = EmployersSnapshot.size;

      // Count Jobs
      const jobsSnapshot = await getDocs(collection(db, "jobs"));
      animateValue("totalJobs", jobsSnapshot.size);
      document.getElementById('totalJobs').innerText = jobsSnapshot.size;
    } catch (error) {
      console.error("Error loading stats:", error);
    }
  }

  /**
   * Loads recent user and job activity for admin dashboard
   */
  async function loadRecentActivity() {
    try {
      // Recent Users
      const usersQuery = query(collection(db, "users"), where("role", "in", ["fresher", "Employer"]));
      const usersSnapshot = await getDocs(usersQuery);
      
      const usersData = [];
      usersSnapshot.forEach(doc => usersData.push({ id: doc.id, ...doc.data() }));
      
      // Sort by creation date (newest first)
      usersData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      const last5Users = usersData.slice(0, 5);
      
      const usersTable = document.getElementById('recentUsersTable');
      usersTable.innerHTML = "";
      last5Users.forEach(user => {
        usersTable.innerHTML += `<tr><td>${user.email}</td><td>${user.role}</td></tr>`;
      });

      // Recent Jobs
      const jobsSnapshot = await getDocs(collection(db, "jobs"));
      const jobsData = [];
      jobsSnapshot.forEach(doc => jobsData.push({ id: doc.id, ...doc.data() }));

       // Sort by creation date (newest first)
  jobsData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  const last5Jobs = jobsData.slice(0, 5);
  
  const jobsTable = document.getElementById('recentJobsTable');
  jobsTable.innerHTML = "";
  last5Jobs.forEach(job => {
    jobsTable.innerHTML += `
      <tr>
        <td>${job.Title || 'N/A'}</td>
        <td>${job.Employer || 'N/A'}</td>
        <td>${job.location || 'N/A'}</td>
      </tr>`;
  });
} catch (error) {
  console.error("Error loading recent activity:", error);
}
}

/*
=============================================
EVENT LISTENERS
=============================================
Sets up all event handlers when DOM is loaded
*/

document.addEventListener('DOMContentLoaded', () => {
// Toggle between login/signup forms
const toggleLink = document.getElementById('toggleLink');
toggleLink.addEventListener('click', (e) => {
e.preventDefault();
toggleForm();
});
});
    // Admin menu navigation
document.getElementById('adminMenuHome').addEventListener('click', (e) => {
  e.preventDefault();
  showAdminSection('home');
  toggleAdminMenu();
});

document.getElementById('adminMenuUsers').addEventListener('click', (e) => {
  e.preventDefault();
  showAdminSection('users');
  toggleAdminMenu();
});

document.getElementById('adminMenuJobs').addEventListener('click', (e) => {
  e.preventDefault();
  showAdminSection('jobs');
  toggleAdminMenu();
});

document.getElementById('adminMenuSettings').addEventListener('click', (e) => {
  e.preventDefault();
  showAdminSection('settings');
  loadAdminManagement();
  toggleAdminMenu();
});

// Employer menu navigation
document.getElementById('EmployerMenuHome').addEventListener('click', (e) => {
  e.preventDefault();
  showEmployerSection('home');
  toggleEmployerMenu();
});

document.getElementById('EmployerMenuPostJob').addEventListener('click', (e) => {
  e.preventDefault();
  showEmployerSection('postJob');
  toggleEmployerMenu();
});

document.getElementById('EmployerMenuMyJobs').addEventListener('click', (e) => {
  e.preventDefault();
  showEmployerSection('myJobs');
  toggleEmployerMenu();
});

// Fresher menu navigation
document.getElementById('fresherMenuHome').addEventListener('click', (e) => {
  e.preventDefault();
  showFresherSection('home');
  toggleFresherMenu();
});

document.getElementById('fresherMenuJobs').addEventListener('click', (e) => {
  e.preventDefault();
  showFresherSection('jobs');
  toggleFresherMenu();
});

document.getElementById('fresherMenuApplications').addEventListener('click', (e) => {
  e.preventDefault();
  showFresherSection('applications');
  toggleFresherMenu();
});

document.getElementById('fresherMenuProfile').addEventListener('click', (e) => {
  e.preventDefault();
  showFresherSection('profile');
  toggleFresherMenu();
});

// Post Job Form submission handler
const postJobForm = document.getElementById('postJobForm');
if (postJobForm) {
  postJobForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const title = document.getElementById('jobTitle').value;
    const description = document.getElementById('jobDescription').value;
    const location = document.getElementById('jobLocation').value;
    const salary = document.getElementById('jobSalary').value;
    
    try {
      const user = auth.currentUser;
      if (!user) throw new Error("Not authenticated");
      
      await addDoc(collection(db, "jobs"), {
        Title: title,
        description: description,
        location: location,
        salary: salary,
        Employer: user.email,
        createdAt: new Date().toISOString()
      });
      
      alert("Job posted successfully!");
      postJobForm.reset();
    } catch (error) {
      alert("Error posting job: " + error.message);
    }
  });
}

// Auth state change handler

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
      const userData = userSnap.data();
      const initialRole = userData.role;

      showDashboard(initialRole);

      // ‚úÖ Listen for real-time role changes and logout
      onSnapshot(userRef, (docSnap) => {
        const updatedData = docSnap.data();
        if (!updatedData) return;

        const newRole = updatedData.role;
        if (newRole !== initialRole) {
          alert("Your role has changed. You will be logged out.");
          signOut(auth).then(() => {
            window.location.href = "/";
          });
        }
      });
    }
  }
});



/*
=============================================
PLACEHOLDER FUNCTIONS
=============================================
Temporary implementations for future features
*/

/** Loads employer's job listings (placeholder) */
window.loadEmployerJobs = function() {
  document.getElementById('EmployerJobsTable').innerHTML = `<tr><td colspan="4">Job listings will appear here</td></tr>`;
};

/** Loads available jobs for freshers (placeholder) */
window.loadAvailableJobs = function() {
  document.getElementById('availableJobsTable').innerHTML = `<tr><td colspan="5">Available jobs will appear here</td></tr>`;
};

/** Loads fresher's job applications (placeholder) */
window.loadMyApplications = function() {
  document.getElementById('myApplicationsTable').innerHTML = `<tr><td colspan="4">Your applications will appear here</td></tr>`;
};

/** Loads fresher profile data (placeholder) */
window.loadFresherProfile = function() {
// Would load profile data here
};

/*
=============================================
UTILITY FUNCTIONS
=============================================
Helper functions used throughout the application
*/

/**

Animates a number counting up to a target value

@param {string} element - ID of the element to animate

@param {number} target - Target value to count to

@param {number} duration - Animation duration in ms (default: 1000)
*/
function animateValue(element, target, duration = 1000) {
const start = 0;
const increment = target / (duration / 16); // 60fps
let current = start;
const el = document.getElementById(element);
  const timer = setInterval(() => {
      current += increment;
  if (current >= target) {
    clearInterval(timer);
    current = target;
  }
  el.textContent = Math.floor(current);
}, 16);
  }


</script>

</body> 
</html>
